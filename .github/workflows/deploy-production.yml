name: Deploy to Production

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy-frontend:
    name: Deploy Frontend to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write  # gh-pagesブランチにpushするために必要
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          cd apps/web
          npm ci

      - name: Build Frontend
        run: |
          cd apps/web
          API_URL=${{ secrets.API_URL }} npm run build -- --configuration=production --base-href=${{ secrets.BASE_HREF || '/' }}

      - name: Create 404.html for SPA routing
        run: |
          cd apps/web/dist/web/browser
          cp index.html 404.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/web/dist/web/browser
          cname: ${{ secrets.CUSTOM_DOMAIN }}

  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    if: false  # 一時的に無効化
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker Image
        run: |
          docker build -f apps/api/Dockerfile \
            -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/daily-report/daily-report-api:${{ github.sha }} \
            -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/daily-report/daily-report-api:latest \
            .

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/daily-report/daily-report-api:${{ github.sha }}
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/daily-report/daily-report-api:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy daily-report-api \
            --image ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/daily-report/daily-report-api:${{ github.sha }} \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --concurrency 1 \
            --set-env-vars NODE_ENV=production,DB_PATH=/tmp/daily-report.db,GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }},CORS_ORIGIN=${{ secrets.CORS_ORIGIN }},BATCH_SIZE=${{ secrets.BATCH_SIZE || '10' }} \
            --update-secrets JWT_SECRET=jwt-secret:latest
