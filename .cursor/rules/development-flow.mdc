---
description: "機能開発の標準フロー。設計→実装→検証→完了の各フェーズとレビュープロセスを定義"
alwaysApply: true
---

# 機能開発フロー

1機能を開発する際の標準的な流れを定義します。

**各ロールの詳細ルールは `docs/rules/jobs/*.md` を参照**

---

## 全体フロー

```
Phase 1: 設計
├── [PdM] PRD作成・セルフレビュー
├── [Driver] フロー監視：PRD作成状況を確認
├── [Eng] Tech Spec作成
├── [Helper] tech_spec.mdレビュー（横断的レビュー）
├── [PdM] tech_spec.mdレビュー（要件充足度確認）
├── [Driver] フロー監視：Tech Specレビュー完了を確認
├── [Des] UI Design作成
├── [PdM] ui_design.mdレビュー
├── [Helper] ui_design.mdレビュー（横断的レビュー）
├── クロスレビュー（Eng/Des）
├── [Driver] フロー監視：UI Designレビュー完了を確認
├── [Des] プロトタイプ作成（必須、HTML/CSS/JS）
├── [human] プロトタイプレビュー（UIUX・要件判断支援）
├── [Driver] フロー監視：実装開始前の最終確認（すべての設計ドキュメントがApprovedか確認）
├── [human] 最終確認と実装承認（必須：プロトタイプ・各種ドキュメントの最終確認）
└── [Driver] 実装開始の承認（人間（human）からの承認がある場合のみ）

Phase 2: 実装
├── [Eng] BE実装（TDD）
├── [Des] FE実装（Storybookファースト）
└── [Driver] フロー監視：TDD、Storybookファーストの遵守を確認

Phase 3: 検証
├── 結合テスト
├── E2Eテスト
├── カバレッジ100%確認（必須）
└── [Driver] フロー監視：品質基準（Lint、テスト、E2E）の遵守を確認

Phase 4: 完了
├── [PdM] 受け入れ確認
├── [human] 成果物レビュー（実装完了後の最終確認）
├── 振り返り（Retro）[PdM, Eng, Des]
├── [Driver] フロー監視：振り返り完了を確認
└── [Driver] コミット・プッシュの承認・実行
```

**Driverの役割**: 各フェーズで開発フローの遵守を監視し、適切なタイミングで次のステップに進むよう推進する。フロー違反や品質基準未達の場合は、**一つのセッション内でロールを切り替えて**適切なロールとして修正を進める。

**Driverの指示方法**: 一つのセッション内でロールを切り替える方式を採用する。回答の冒頭に`[Role: X]`（XはPdM, Eng, Des, Helperのいずれか）を明記することで、そのロールとして作業を進める。

---

## Phase 1: 設計

### ドキュメントステータス管理

すべての設計ドキュメント（`prd.md`, `tech_spec.md`, `ui_design.md`）は、ドキュメント先頭にステータスを記載する：

```markdown
**ステータス**: Pending / Approved
```

- **Pending**: レビュー中または修正中
- **Approved**: レビュー完了、実装開始可能

**重要**: すべての設計ドキュメントが **Approved** ステータスにならない限り、実装を開始してはならない。

### 成果物

| ロール | 成果物                                                      | 詳細ルール                 |
| ------ | ----------------------------------------------------------- | -------------------------- |
| PdM    | `prd.md`                                                    | → `docs/rules/jobs/pdm.md` |
| Eng    | `tech_research.md`, `tech_spec.md`                          | → `docs/rules/jobs/eng.md` |
| Des    | `des_research.md`, `ui_design.md`, **プロトタイプ（必須）** | → `docs/rules/jobs/des.md` |

### PRD作成・セルフレビュー

PdMが `prd.md` を作成し、セルフレビューを実施：

- 要件が明確に定義されているか
- ユーザーストーリーが明確か
- エッジケースが洗い出されているか
- ビジネスルールが明文化されているか

**フィードバック反映**: セルフレビューで発見した問題点を修正し、`prd.md` のステータスを **Approved** に更新。

### Tech Spec作成・レビュー

Engが `tech_spec.md` を作成。

#### Helperレビュー（tech_spec.md）

Helperが `tech_spec.md` を横断的にレビューし、以下を確認：

- [ ] エッジケース・境界値の検討が十分か
- [ ] パフォーマンス・最適化の方針が明確か
- [ ] セキュリティ・データ整合性の考慮が適切か
- [ ] 過去の実績や失敗事例から学ぶべき点はないか
- [ ] 実装前に検討すべき事項が洗い出されているか

**フィードバック反映**: Helperからのフィードバックを `tech_spec.md` に反映。必要に応じて `docs/features/{feature_name}/helper_review.md` に記録。

#### PdMレビュー（tech_spec.md）

PdMが `tech_spec.md` をレビューし、以下を確認：

- [ ] `prd.md` の要件が正しく実現されているか
- [ ] 要件充足度は十分か
- [ ] ビジネスルールが正しく反映されているか

**フィードバック反映**: PdMからのフィードバックを `tech_spec.md` に反映。レビュー完了後、`tech_spec.md` のステータスを **Approved** に更新。

### UI Design作成・レビュー

Desが `ui_design.md` を作成。

**重要**: `ui_design.md`作成時に、既存コンポーネントの使用計画を事前にプランニングすること。実装時に既存コンポーネントを確認するのではなく、設計段階で使用する既存コンポーネントを明確にする。

#### PdMレビュー（ui_design.md）

PdMが `ui_design.md` をレビューし、以下を確認：

- [ ] `prd.md` の要件が正しく解釈されているか
- [ ] ユーザーストーリーの流れが実現されているか
- [ ] エラーハンドリングが適切に設計されているか
- [ ] 画面遷移が自然か
- [ ] メッセージ仕様が正しく反映されているか

**フィードバック反映**: PdMからのフィードバックを `ui_design.md` に反映。

#### Helperレビュー（ui_design.md）

Helperが `ui_design.md` を横断的にレビューし、以下を確認：

- [ ] エッジケース・境界値の検討が十分か
- [ ] パフォーマンス・最適化の方針が明確か
- [ ] ユーザビリティの観点で不足している点はないか
- [ ] 過去の実績や失敗事例から学ぶべき点はないか
- [ ] 実装前に検討すべき事項が洗い出されているか

**フィードバック反映**: Helperからのフィードバックを `ui_design.md` に反映。必要に応じて `docs/features/{feature_name}/helper_review.md` に記録。

### クロスレビュー

Eng/Des間で `tech_spec.md` と `ui_design.md` の整合性を確認：

- [ ] UIが必要とするデータがAPIで提供されるか
- [ ] UIの操作（ボタン押下等）に対応するAPIが定義されているか
- [ ] 齟齬があれば協議・調整

**フィードバック反映**: クロスレビューで発見した齟齬を `tech_spec.md` と `ui_design.md` に反映。レビュー完了後、`ui_design.md` のステータスを **Approved** に更新。

### プロトタイプ作成・レビュー（必須）

Desが `ui_design.md` を元にHTML/CSS/JavaScriptでプロトタイプを作成：

- 実際に見た目が実装されている
- 機能の挙動が紙芝居的にわかる（ボタンクリックで次の状態に遷移等）
- 主要な状態（正常系・エラー・ローディング等）が表現されている
- `docs/features/{feature_name}/mockups/` に配置する

**人間（human）**がプロトタイプをレビューし、以下を判断・支援：

- [ ] UIUXや要件面での判断を支援（DesやPdMの判断に迷いがある場合）
- [ ] 実際の操作感は自然か
- [ ] 使いやすさに問題はないか
- [ ] 視覚的なフィードバックは適切か
- [ ] 操作の流れに迷いがないか
- [ ] 改善すべき点はないか

**フィードバック反映**: humanからのフィードバックを `ui_design.md` や `prd.md` に反映。必要に応じてプロトタイプも更新。

→ 詳細は `docs/rules/prototype.md` を参照

### 実装開始前の最終確認

Phase 1の最後に、**Driver**が以下を確認：

- [ ] `prd.md` のステータスが **Approved**
- [ ] `tech_spec.md` のステータスが **Approved**
- [ ] `ui_design.md` のステータスが **Approved**
- [ ] すべてのレビューが完了し、フィードバックが反映されている
- [ ] プロトタイプレビューが完了している（実施した場合）

**重要**: すべての設計ドキュメントが **Approved** ステータスにならない限り、Phase 2（実装）に進んではならない。

### 人間（human）による最終確認と実装承認（必須）

**Driver**が実装開始前の最終確認を完了した後、**人間（human）**が以下を最終確認し、実装を承認する：

- [ ] すべての設計ドキュメント（`prd.md`, `tech_spec.md`, `ui_design.md`）の内容を確認
- [ ] プロトタイプ（mockup）を確認し、UIUXや要件面での問題がないか判断
- [ ] 設計の方向性に問題がないか判断
- [ ] 実装開始の承認

**承認記録**: 人間（human）による最終確認と承認は、`docs/features/{feature_name}/human_check.md` に記録する。

- テンプレート: `docs/templates/human_check.template.md` を参照
- 承認日、承認者、確認項目、承認結果を記載
- ステータスを **Approved** に更新することで承認を明示

**重要**: 
- **人間（human）が実装を承認するまで、Phase 2（実装）に進んではならない。**
- 人間（human）は最終判断者として、プロトタイプや各種ドキュメントを確認し、実装開始を承認する。
- 人間（human）からの承認がない場合、Driverは実装開始を承認してはならない。
- `human_check.md` のステータスが **Approved** にならない限り、実装を開始してはならない。

**Driverの責務**: 
- 実装開始前の最終確認を実施し、すべての条件が満たされている場合のみ人間（human）に最終確認を依頼する。
- `human_check.md` を作成し、人間（human）に確認を依頼する。
- 人間（human）からの実装承認（`human_check.md` のステータスが **Approved**）を得るまで、Phase 2（実装）に進まない。
- 条件が満たされていない場合は、適切なロールに切り替えて修正を進める（例: `[Role: PdM]`としてPRDのステータスをApprovedに更新する）。

---

## Phase 2: 実装

### Eng（BE実装）

```bash
# TDDで実装
cd apps/api && npm run test:watch

# カバレッジ確認
npm run test:coverage
```

→ 詳細は `docs/rules/jobs/eng.md` を参照

### Des（FE実装）

```bash
# Storybookを起動しながら実装
npm run storybook
```

**重要**: 
- **既存コンポーネントの活用**: `ui_design.md`で事前にプランニングした既存コンポーネントを使用すること。
- **新規コンポーネントの作成**: 新規コンポーネントが必要な場合は、FE実装と同時に作成すること。実装完了後に新規コンポーネントを作成するのではなく、実装と同時に行う。
- **Storybookへの反映（必須）**: 
  - 新規コンポーネントを作成する場合は、FE実装と同時にStorybookストーリーも作成すること。
  - `src/stories/components/` に `ComponentName.stories.ts` を作成し、各バリエーション（状態、サイズ等）のストーリーを作成する。
  - 既存コンポーネントの変更もStorybookに反映する。
  - Storybookへのコンポーネント反映は受け入れ条件のひとつとして必須とする。
- **実装完了時の確認**: 実装完了時に、すべてのコンポーネントがStorybookに反映されていることを確認すること。

→ 詳細は `docs/rules/jobs/des.md` を参照

---

## Phase 3: 検証

```bash
# FE/BE起動
cd apps/api && npm run dev   # ターミナル1
cd apps/web && npm run dev   # ターミナル2

# E2Eテスト（Cypress）
cd apps/web && npm run e2e
```

### E2Eテストの作成・実行

実装完了後、**ユースケース（PRDのユーザーストーリー）に基づいてE2Eテストを作成・実行する**：

#### E2Eテスト作成の手順

1. **PRDのユーザーストーリーを確認**
   - `docs/features/{feature_name}/prd.md` の「ユーザーストーリー」セクションを参照
   - 各ユーザーストーリー（US-1, US-2, ...）に対応するテストケースを作成

2. **E2Eテストファイルの作成**
   - `apps/web/cypress/e2e/{feature_name}.cy.ts` に新規テストファイルを作成
   - 既存のE2Eテスト（`apps/web/cypress/e2e/followup-enhancement.cy.ts` 等）を参考にする

3. **テストケースの構成**
   - 各ユーザーストーリーごとに `test.describe()` ブロックを作成
   - テストケース名はユーザーストーリーの内容を反映する
   - 正常系・異常系・エッジケースを網羅する

4. **テスト実行**
   ```bash
   # 新規追加したテストファイルのみ実行（推奨）
   # push時にpre-pushフックで全E2Eテストが自動実行されるため、新規追加分のみ確認すればよい
   cd apps/web && npx cypress run --spec cypress/e2e/{feature_name}.cy.ts
   
   # UIモードで実行（デバッグに便利）
   cd apps/web && npm run e2e:ui
   
   # 全E2Eテスト実行（必要に応じて）
   cd apps/web && npm run e2e
   ```
   
   **重要**: 
   - **push時にpre-pushフックで全E2Eテストが自動実行される**ため、実装時は新規追加したテストファイルのみを実行して確認すればよい
   - すべてのテストはpush時に自動実行され、失敗した場合はpushが中断される

#### E2Eテストの品質基準

- [ ] すべてのユーザーストーリーがカバーされている
- [ ] 主要な画面遷移がテストされている
- [ ] 正常系・異常系・エッジケースがテストされている
- [ ] テストが安定して実行できる（フレーキーでない）
- [ ] テスト実行時間が適切（1テストあたり30秒以内を目安）

**重要**: E2Eテストが失敗した場合は、実装の問題かテストの問題かを特定し、修正してから次のフェーズに進むこと。

### カバレッジ100%の確認

実装完了後、必ずカバレッジが100%であることを確認する：

```bash
# Webアプリのカバレッジ確認
cd apps/web && npm run test:coverage

# APIのカバレッジ確認（該当する場合）
cd apps/api && npm run test:coverage
```

**重要**: カバレッジが100%未満の場合は、不足しているテストを追加してから次のフェーズに進むこと。

> ⚠️ **カバレッジ100%は必須**
> 詳細は `docs/general/test_rules.md` の「カバレッジ100%必須ルール」を参照

---

## Phase 4: 完了

### 受け入れ確認

PdMがPRDの要件充足を確認

### 人間（human）レビュー（成果物）

実装完了後、人間（human）が成果物をレビューし、以下を確認：

- [ ] 実装された機能が要件を満たしているか
- [ ] UIUXの品質は十分か
- [ ] 品質基準（lint、テスト、E2E）を満たしているか
- [ ] 実装の方向性に問題はないか
- [ ] 改善が必要な点はないか

**役割**: 人間（human）は最終判断者として、実装完了後の成果物をレビューし、品質や方向性に関する最終的な判断を下す。

### 品質チェックリスト

- [ ] `npm run lint` パス
- [ ] `npm run test` パス（カバレッジ100%）
- [ ] `npm run e2e` パス
- [ ] **Storybook に全コンポーネント反映（必須）**
  - 新規コンポーネントはFE実装と同時にStorybookストーリーを作成
  - 既存コンポーネントの変更もStorybookに反映
  - すべてのバリエーション（状態、サイズ等）のストーリーが作成されている

> ⚠️ **カバレッジ100%は必須**
> 詳細は `docs/general/test_rules.md` の「カバレッジ100%必須ルール」を参照

> ⚠️ **Storybookへの反映は必須**
> Storybookへのコンポーネント反映は受け入れ条件のひとつとして必須とする。実装完了時に、すべてのコンポーネントがStorybookに反映されていることを確認すること。

### 振り返り

**PdM、Eng、Desの3者で実施**

`docs/retro/{feature_name}/` に以下を作成：

- `retro.md` - 全体まとめ（Keep/Problem/Try/Learnings）
- `pdm.md` - PdMロール別振り返り（必須）
- `eng.md` - Engロール別振り返り（必須）
- `des.md` - Desロール別振り返り（必須）

各ロールは自身の観点から振り返りを行い、学びを `docs/rules/jobs/*.md` に反映する。

### コミット・プッシュ

振り返りが完了したら、**Driver**がすべての変更をコミット・プッシュする：

```bash
# 変更をステージング
git add .

# コミット（機能名を含める）
git commit -m "feat: {機能名} 実装完了

- 実装内容の概要
- カバレッジ100%確認済み
- 振り返り完了"

# プッシュ（pre-pushフックで自動的にlint、テスト、E2Eが実行される）
git push
```

**重要**: 
- 振り返りが完了するまで、コミット・プッシュは行わないこと
- プッシュ前にpre-pushフックで自動的に以下が実行される：
  - Lintチェック
  - カバレッジチェック（100%必須）
  - ユニットテスト（全ワークスペース）
  - E2Eテスト（全テストファイル）
- **E2Eテストの実行タイミング**:
  - 実装時: 新規追加したテストファイルのみを実行して確認（`npx cypress run --spec cypress/e2e/{feature_name}.cy.ts`）
  - push時: pre-pushフックで全E2Eテストが自動実行されるため、実装時は新規追加分のみ確認すればよい

**Driverの責務**: 振り返りが完了し、すべての品質基準を満たしていることを確認した上で、コミット・プッシュを実行する。品質基準が満たされていない場合は、適切なロールに切り替えて修正を進める（例: `[Role: Eng]`としてLintエラーを修正する、`[Role: Des]`としてテストカバレッジが100%未満の場合はテストを追加する）。

---

## クイックリファレンス

### コマンド一覧

| 目的            | コマンド                     |
| --------------- | ---------------------------- |
| API開発サーバー | `cd apps/api && npm run dev` |
| Web開発サーバー | `cd apps/web && npm run dev` |
| Storybook       | `npm run storybook`          |
| Lint            | `npm run lint`               |
| ユニットテスト  | `npm run test`               |
| カバレッジ      | `npm run test:coverage`      |
| E2Eテスト       | `cd apps/web && npm run e2e` |

### 参照ドキュメント

| ドキュメント                    | 内容                                       |
| ------------------------------- | ------------------------------------------ |
| `docs/rules/jobs/pdm.md`        | PdMルール（PRD作成方法等）                 |
| `docs/rules/jobs/eng.md`        | Engルール（TDD、コンポーネント設計等）     |
| `docs/rules/jobs/des.md`        | Desルール（Storybook、デザイントークン等） |
| `docs/general/test_rules.md`    | テストスニペット集                         |
| `docs/general/design_system.md` | デザインシステム                           |
