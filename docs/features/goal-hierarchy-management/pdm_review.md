# 目標階層管理機能 PdMレビュー

**バージョン**: v1  
**作成日**: 2025-12-13  
**作成者**: PdM  
**ステータス**: Approved  
**レビュー対象**: `tech_spec.md`

---

## 1. レビュー概要

`tech_spec.md` をレビューし、`prd.md` の要件が正しく実現されているか、要件充足度は十分か、ビジネスルールが正しく反映されているかを確認する。

---

## 2. PRD ↔ Tech Spec 整合性チェック

### ✅ 整合している項目

| 項目                     | PRD                                        | Tech Spec                                      | 状態 |
| :----------------------- | :----------------------------------------- | :--------------------------------------------- | :--- |
| 目標の階層構造定義・管理 | 目標を階層的に定義・管理できる             | Goalモデル、parentIdによる階層表現             | ✅   |
| 目標の期間設定           | 柔軟な期間設定（半期、四半期、1ヶ月等）    | startDate/endDateで柔軟に設定可能              | ✅   |
| 目標間の関係性可視化     | 階層構造をツリー形式で表示                 | GET /api/goals (hierarchy=true) で階層構造取得 | ✅   |
| 週次フォーカスとの接続   | 短期目標から週次フォーカスを設定可能       | PUT /api/weekly-focuses/:id/goal で接続        | ✅   |
| 期間の整合性チェック     | 下位目標の期間は上位目標の期間内に収まる   | validatePeriod関数で実装                       | ✅   |
| 循環参照の防止           | 循環参照が発生しない                       | validateCircularReference関数で実装            | ✅   |
| 階層の深さ制限           | 最大4階層まで                              | validateDepth関数で実装                        | ✅   |
| 目標の削除               | 下位目標が存在する場合、削除前に確認が必要 | 下位目標が存在する場合は削除を許可しない       | ✅   |

---

## 3. 要件充足度の確認

### 3.1 目標の作成・編集・削除

**PRD要件**: 目標の作成・編集・削除が可能

**Tech Spec実装**: ✅ 適切

- POST /api/goals で目標を作成可能
- PUT /api/goals/:id で目標を更新可能
- DELETE /api/goals/:id で目標を削除可能
- 目標の基本情報（目標名、説明、期間、階層、性質、達成基準）が適切に定義されている

**確認結果**: ✅ 要件を満たしている

### 3.2 目標の階層的ブレイクダウン

**PRD要件**: 長期目標から中期目標、短期目標へと階層的にブレイクダウンできる

**Tech Spec実装**: ✅ 適切

- POST /api/goals で `parentId` を指定して下位目標を作成可能
- 階層構造を再帰的に取得可能（GET /api/goals hierarchy=true）
- 階層の深さは最大4階層まで制限

**確認結果**: ✅ 要件を満たしている

### 3.3 目標間の関係性の可視化

**PRD要件**: 目標間の関係性（因果関係、依存関係）を明確に可視化できる

**Tech Spec実装**: ✅ 適切

- GET /api/goals (hierarchy=true) で階層構造を取得可能
- 階層構造をツリー形式で返却（`children` 配列）
- GET /api/goals/:id で目標詳細と親子関係を取得可能

**確認結果**: ✅ 要件を満たしている

### 3.4 週次フォーカスと短期目標の接続

**PRD要件**: 短期目標から週次フォーカスを設定可能

**Tech Spec実装**: ✅ 適切

- PUT /api/weekly-focuses/:id/goal で週次フォーカスと短期目標を接続可能
- DELETE /api/weekly-focuses/:id/goal で接続を解除可能
- 接続する目標は短期目標（最下位階層）であることをバリデーション
- `WeeklyFocus` モデルに `goalId` フィールドを追加（後方互換性を保つ）

**確認結果**: ✅ 要件を満たしている

### 3.5 目標の性質に応じたブレイクダウン方法のサポート

**PRD要件**: 目標の性質に応じたブレイクダウン方法をサポートできる

**Tech Spec実装**: ✅ 適切（Phase 1では基本的なサポート）

- `goalType` フィールドで目標の性質を設定可能（'skill' | 'project' | 'habit' | 'other'）
- Phase 1では基本的なサポート（将来実装としてガイド表示等を予定）

**確認結果**: ✅ 要件を満たしている（Phase 1の範囲内）

---

## 4. ビジネスルールの確認

### 4.1 階層構造の整合性

**PRD要件**: 下位目標は必ず1つの上位目標に紐づく（1対多の関係）

**Tech Spec実装**: ✅ 適切

- `parentId` フィールドで1対多の関係を表現
- 下位目標は必ず1つの上位目標に紐づく（`parentId` は1つの値のみ）

**確認結果**: ✅ ビジネスルールが正しく反映されている

### 4.2 期間の整合性

**PRD要件**: 下位目標の期間は上位目標の期間内に収まること

**Tech Spec実装**: ✅ 適切

- `validatePeriod` 関数で期間の整合性をチェック
- 下位目標の期間が上位目標の期間外の場合はエラーメッセージを返却
- 目標更新時も期間の整合性を確認

**確認結果**: ✅ ビジネスルールが正しく反映されている

### 4.3 循環参照の防止

**PRD要件**: 目標Aが目標Bの上位目標である場合、目標Bを目標Aの上位目標に設定することはできない

**Tech Spec実装**: ✅ 適切

- `validateCircularReference` 関数で循環参照を防止
- 循環参照が発生する場合はエラーメッセージを返却

**確認結果**: ✅ ビジネスルールが正しく反映されている

### 4.4 目標の削除

**PRD要件**: 下位目標が存在する場合、削除前に確認が必要（将来実装）

**Tech Spec実装**: ✅ 適切

- Phase 1では、下位目標が存在する場合は削除を許可しない（エラーメッセージを返却）
- 将来実装として、削除前に確認ダイアログを表示する予定

**確認結果**: ✅ ビジネスルールが正しく反映されている

### 4.5 週次フォーカスとの接続

**PRD要件**: 短期目標から週次フォーカスを設定可能

**Tech Spec実装**: ✅ 適切

- 接続する目標は短期目標（最下位階層）であることをバリデーション
- 接続する目標はユーザーの所有物であることを確認

**確認結果**: ✅ ビジネスルールが正しく反映されている

---

## 5. 受入基準（AC）の確認

### ✅ 受入基準の実現確認

| AC   | 受入基準                       | Tech Specでの実現方法            | 状態 |
| :--- | :----------------------------- | :------------------------------- | :--- |
| AC-1 | 長期目標の作成                 | POST /api/goals (parentId=null)  | ✅   |
| AC-2 | 目標の階層的ブレイクダウン     | POST /api/goals (parentId指定)   | ✅   |
| AC-3 | 目標間の関係性の可視化         | GET /api/goals (hierarchy=true)  | ✅   |
| AC-4 | 週次フォーカスと短期目標の接続 | PUT /api/weekly-focuses/:id/goal | ✅   |
| AC-5 | 目標の編集                     | PUT /api/goals/:id               | ✅   |
| AC-6 | 目標の削除                     | DELETE /api/goals/:id            | ✅   |
| AC-7 | 期間の整合性チェック           | validatePeriod関数               | ✅   |
| AC-8 | 循環参照の防止                 | validateCircularReference関数    | ✅   |

**確認結果**: ✅ すべての受入基準を満たしている

---

## 6. Helperレビューのフィードバック確認

### 6.1 改善提案の反映確認

**Helperレビュー改善提案**: 目標削除時の週次フォーカス接続の扱い

**確認結果**: ✅ 反映済み

- Tech Specに「削除対象の目標に接続されている週次フォーカス（`goalId` が削除対象の目標ID）を検索し、該当する週次フォーカスの `goalId` を `null` に更新する」と追加されている
- Helperレビューの改善提案が適切に反映されている

---

## 7. 総合評価

### ✅ 承認

Tech SpecはPRDの要件を正しく実現しており、要件充足度は十分です。ビジネスルールも正しく反映されています。

**良好な点**:

- PRDの要件がすべてTech Specに反映されている
- 既存のAPIパターンや関数を再利用し、一貫性を保っている
- エッジケースやエラーハンドリングが適切に考慮されている
- Helperレビューのフィードバックが反映されている
- 既存の週次フォーカス機能との互換性が保たれている

**改善提案**: なし

**承認者**: PdM  
**承認日**: 2025-12-13

---

## 8. 次のステップ

1. **Tech Specのステータス更新**
   - Helperレビュー・PdMレビュー完了後、Tech Specのステータスを **Approved** に更新

2. **UI Design作成**
   - DesロールがUI Designを作成

3. **実装開始**
   - すべての設計ドキュメントがApprovedステータスになったら、実装を開始

---

_本PdMレビューは完了しました。Tech Specは承認されました。_
