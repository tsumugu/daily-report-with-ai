# Cloud Storage API read/write量のコスト影響分析

**作成日**: 2025-01-XX  
**作成者**: Eng  
**目的**: Cloud Storage API経由の実装によるread/write操作の増加がコストに与える影響を分析

---

## 📋 分析概要

Cloud Storage API経由の実装では、以下の操作が発生します：

1. **起動時**: Cloud StorageからSQLiteファイルをダウンロード（読み取り）
2. **リクエスト処理後**: 非同期でCloud Storageにアップロード（書き込み）
3. **終了時**: Cloud Storageにアップロード（書き込み）

これらの操作が増加することで、Cloud Storage APIのオペレーション料金が発生する可能性があります。

---

## 1. Cloud Storage APIの料金体系

### 1.1 オペレーション料金

**クラスAオペレーション（書き込み・変更）**:

- 料金: **10,000回あたり$0.05**
- 例: `upload()`, `save()`, `delete()`, `copy()`など

**クラスBオペレーション（読み取り・メタデータ取得）**:

- 料金: **10,000回あたり$0.004**
- 例: `download()`, `exists()`, `getMetadata()`など

**無料枠**:

- **クラスA**: 月5,000回まで無料
- **クラスB**: 月50,000回まで無料

### 1.2 ストレージ料金

**Standard Storage（東京リージョン）**:

- 料金: **1GBあたり月額$0.023**
- 無料枠: 月5GBまで無料

### 1.3 データ転送料金

**同一リージョン内（Cloud Run → Cloud Storage）**:

- **無料**（同一リージョン内の転送は無料）

**外部への転送**:

- 最初の1TB: 1GBあたり$0.12
- 次の9TB: 1GBあたり$0.11
- それ以降: 1GBあたり$0.08

**注意**: Cloud RunとCloud Storageが同一リージョン（`asia-northeast1`）の場合、データ転送は無料です。

---

## 2. 想定される使用量の計算

### 2.1 実装パターンの整理

**パターン1: コールドスタート時**

- 起動時にダウンロード: **クラスBオペレーション 1回**
- SQLiteファイルサイズ: 仮に10MBと仮定

**パターン2: リクエスト処理後**

- 非同期でアップロード: **クラスAオペレーション 1回**
- SQLiteファイルサイズ: 仮に10MBと仮定

**パターン3: 終了時**

- アップロード: **クラスAオペレーション 1回**
- SQLiteファイルサイズ: 仮に10MBと仮定

### 2.2 使用量のシナリオ別計算

#### シナリオ1: 小規模利用（月10万リクエスト）

**前提条件**:

- Cloud Runリクエスト数: 月10万回
- コールドスタート回数: 月100回（最小インスタンス数0の場合）
- リクエスト処理後のアップロード: 月10万回（すべてのリクエストで書き込みがあると仮定）
- 終了時のアップロード: 月100回（コールドスタート回数と同じ）

**オペレーション回数**:

- **クラスA（書き込み）**: 100,100回
  - リクエスト処理後: 100,000回
  - 終了時: 100回
- **クラスB（読み取り）**: 100回
  - 起動時: 100回

**コスト計算**:

- クラスA: (100,100 - 5,000) / 10,000 × $0.05 = **$0.475**
- クラスB: 100回（無料枠内） = **$0**
- **合計**: **約$0.48/月**

#### シナリオ2: 中規模利用（月100万リクエスト）

**前提条件**:

- Cloud Runリクエスト数: 月100万回
- コールドスタート回数: 月1,000回
- リクエスト処理後のアップロード: 月100万回
- 終了時のアップロード: 月1,000回

**オペレーション回数**:

- **クラスA（書き込み）**: 1,001,000回
- **クラスB（読み取り）**: 1,000回

**コスト計算**:

- クラスA: (1,001,000 - 5,000) / 10,000 × $0.05 = **$4.98**
- クラスB: 1,000回（無料枠内） = **$0**
- **合計**: **約$5.00/月**

#### シナリオ3: 大規模利用（月500万リクエスト）

**前提条件**:

- Cloud Runリクエスト数: 月500万回
- コールドスタート回数: 月5,000回
- リクエスト処理後のアップロード: 月500万回
- 終了時のアップロード: 月5,000回

**オペレーション回数**:

- **クラスA（書き込み）**: 5,005,000回
- **クラスB（読み取り）**: 5,000回

**コスト計算**:

- クラスA: (5,005,000 - 5,000) / 10,000 × $0.05 = **$25.00**
- クラスB: 5,000回（無料枠内） = **$0**
- **合計**: **約$25.00/月**

---

## 3. 最適化によるコスト削減

### 3.1 アップロード頻度の最適化

**現状の実装**:

- リクエスト処理後に毎回アップロード

**最適化案1: バッチアップロード**

- 複数のリクエストをまとめてアップロード
- 例: 10リクエストごとに1回アップロード
- **コスト削減**: 約90%（月10万リクエストの場合、$0.48 → $0.05）

**最適化案2: タイムベースアップロード**

- 一定時間ごとにアップロード（例: 5分ごと）
- **コスト削減**: 約80-90%

**最適化案3: 変更検知アップロード**

- データベースに変更があった場合のみアップロード
- **コスト削減**: 読み取りのみのリクエストでは0%

### 3.2 コールドスタート回数の削減

**対策**: 最小インスタンス数を1に設定

- コールドスタート回数: 月100回 → 月1回
- **コスト削減**: クラスAオペレーションが約100回削減（$0.0005）

**注意**: 最小インスタンス数1の設定により、Cloud Runのコストが約$5-10/月増加します。

---

## 4. ストレージ料金への影響

### 4.1 SQLiteファイルサイズの想定

**小規模利用**:

- ユーザー数: 10-50人
- データ量: 1-5MB
- **ストレージ料金**: 無料枠内（5GB未満） = **$0/月**

**中規模利用**:

- ユーザー数: 100-500人
- データ量: 10-50MB
- **ストレージ料金**: 無料枠内（5GB未満） = **$0/月**

**大規模利用**:

- ユーザー数: 1,000-5,000人
- データ量: 100-500MB
- **ストレージ料金**: 無料枠内（5GB未満） = **$0/月**

**評価**: SQLiteファイルサイズは通常数MB〜数百MB程度のため、ストレージ料金への影響は**ほぼなし**です。

---

## 5. データ転送料金への影響

### 5.1 同一リージョン内の転送

**前提**: Cloud RunとCloud Storageが同一リージョン（`asia-northeast1`）の場合

**転送料金**: **無料**

**理由**: GCPでは同一リージョン内のデータ転送は無料です。

### 5.2 外部への転送

**前提**: Cloud Storageから外部（インターネット）への転送

**発生条件**: 通常は発生しません（Cloud RunからCloud Storageへの転送のみ）

**評価**: **データ転送料金への影響はなし**

---

## 6. コスト見積もりの更新

### 6.1 小規模利用（月10万リクエスト）

| 項目                         | 無料枠内 | 無料枠超過 | 合計         |
| :--------------------------- | :------- | :--------- | :----------- |
| Cloud Run                    | $0       | $0         | $0           |
| Cloud Storage（ストレージ）  | $0       | $0         | $0           |
| Cloud Storage API（クラスA） | $0       | $0.48      | **$0.48**    |
| Cloud Storage API（クラスB） | $0       | $0         | $0           |
| Container Registry           | $0       | $0         | $0           |
| **合計**                     | **$0**   | **$0.48**  | **$0.48/月** |

### 6.2 中規模利用（月100万リクエスト）

| 項目                         | 無料枠内 | 無料枠超過 | 合計         |
| :--------------------------- | :------- | :--------- | :----------- |
| Cloud Run                    | $0       | $0.40      | $0.40        |
| Cloud Storage（ストレージ）  | $0       | $0.20      | $0.20        |
| Cloud Storage API（クラスA） | $0       | $4.98      | **$4.98**    |
| Cloud Storage API（クラスB） | $0       | $0         | $0           |
| Container Registry           | $0       | $0.10      | $0.10        |
| **合計**                     | **$0**   | **$5.68**  | **$5.68/月** |

### 6.3 大規模利用（月500万リクエスト）

| 項目                         | 無料枠内 | 無料枠超過 | 合計          |
| :--------------------------- | :------- | :--------- | :------------ |
| Cloud Run                    | $0       | $2.00      | $2.00         |
| Cloud Storage（ストレージ）  | $0       | $0.20      | $0.20         |
| Cloud Storage API（クラスA） | $0       | $25.00     | **$25.00**    |
| Cloud Storage API（クラスB） | $0       | $0         | $0            |
| Container Registry           | $0       | $0.10      | $0.10         |
| **合計**                     | **$0**   | **$27.30** | **$27.30/月** |

---

## 7. コスト最適化の推奨事項

### 7.1 実装レベルの最適化

#### 推奨1: 変更検知アップロード（必須）

**実装方針**:

- データベースに変更があった場合のみアップロード
- 読み取り専用のリクエストではアップロードしない

**効果**:

- 小規模利用: $0.48 → $0.05（約90%削減）
- 中規模利用: $4.98 → $0.50（約90%削減）
- 大規模利用: $25.00 → $2.50（約90%削減）

**実装例**:

```typescript
let hasChanges = false;

// データベース操作時にフラグを立てる
function markAsChanged() {
  hasChanges = true;
}

// リクエスト処理後
app.use(async (req, res, next) => {
  await next();
  if (hasChanges) {
    syncDatabasePeriodically();
    hasChanges = false;
  }
});
```

#### 推奨2: バッチアップロード（推奨）

**実装方針**:

- 複数の変更をまとめてアップロード
- 例: 10リクエストごとに1回アップロード

**効果**:

- さらにコストを削減可能

**実装例**:

```typescript
let changeCount = 0;
const BATCH_SIZE = 10;

app.use(async (req, res, next) => {
  await next();
  if (hasChanges) {
    changeCount++;
    if (changeCount >= BATCH_SIZE) {
      syncDatabasePeriodically();
      changeCount = 0;
      hasChanges = false;
    }
  }
});
```

#### 推奨3: タイムベースアップロード（オプション）

**実装方針**:

- 一定時間ごとにアップロード（例: 5分ごと）
- 最後の変更から一定時間経過後にアップロード

**効果**:

- コストをさらに削減可能
- データ損失のリスクを最小化

---

### 7.2 インフラレベルの最適化

#### 推奨1: 最小インスタンス数の調整

**設定**: 最小インスタンス数1

**効果**:

- コールドスタート回数の削減
- クラスAオペレーションの削減（約100回/月）

**コスト増加**: Cloud Runのコストが約$5-10/月増加

**評価**: コスト削減効果は小さいが、パフォーマンス向上のメリットあり

#### 推奨2: リージョンの選択

**設定**: Cloud RunとCloud Storageを同一リージョンに配置

**効果**:

- データ転送料金が無料

**評価**: **既に実装済み**（`asia-northeast1`）

---

## 8. コスト監視とアラート

### 8.1 コスト監視の設定

**推奨設定**:

- Cloud Billingの予算アラートを設定
- 月額$10を超えた場合にアラート

**監視項目**:

- Cloud Storage APIのオペレーション回数
- Cloud Storageのストレージ使用量
- Cloud Runのリクエスト数

### 8.2 コスト最適化の指標

**KPI**:

- クラスAオペレーション回数/リクエスト数（目標: 0.1以下）
- クラスBオペレーション回数/コールドスタート回数（目標: 1.0）

---

## 9. 総合評価

### 9.1 コストへの影響

| 利用規模                    | 追加コスト（最適化なし） | 追加コスト（最適化あり） | 評価       |
| :-------------------------- | :----------------------- | :----------------------- | :--------- |
| 小規模（月10万リクエスト）  | $0.48/月                 | $0.05/月                 | ⭐⭐⭐⭐⭐ |
| 中規模（月100万リクエスト） | $4.98/月                 | $0.50/月                 | ⭐⭐⭐⭐   |
| 大規模（月500万リクエスト） | $25.00/月                | $2.50/月                 | ⭐⭐⭐     |

**評価**:

- **小規模利用**: コストへの影響は**ほぼなし**（最適化後）
- **中規模利用**: コストへの影響は**許容範囲内**（最適化後）
- **大規模利用**: コストが増加するが、**最適化により削減可能**

### 9.2 推奨事項

**必須実装**:

1. ✅ 変更検知アップロード（データ変更時のみアップロード）
2. ✅ コスト監視とアラートの設定

**推奨実装**: 3. ⭐ バッチアップロード（複数の変更をまとめてアップロード）4. ⭐ タイムベースアップロード（一定時間ごとにアップロード）

**将来の検討事項**: 5. 🔮 トラフィック増加時はCloud SQLへの移行を検討

---

## 10. 結論

### 10.1 コストへの影響のまとめ

**小規模利用（月10万リクエスト）**:

- 追加コスト: **約$0.05-0.48/月**（最適化の有無による）
- **評価**: **コストへの影響はほぼなし**

**中規模利用（月100万リクエスト）**:

- 追加コスト: **約$0.50-4.98/月**（最適化の有無による）
- **評価**: **コストへの影響は許容範囲内**

**大規模利用（月500万リクエスト）**:

- 追加コスト: **約$2.50-25.00/月**（最適化の有無による）
- **評価**: **最適化によりコストを削減可能**

### 10.2 推奨実装方針

**推奨**: **変更検知アップロードを実装**

**理由**:

- コストを約90%削減可能
- 実装が比較的シンプル
- パフォーマンスへの影響も最小限

**実装優先度**:

1. **高**: 変更検知アップロード
2. **中**: バッチアップロード
3. **低**: タイムベースアップロード

---

**最終更新日**: 2025-01-XX
