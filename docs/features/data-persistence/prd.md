# データ永続化機能 要件定義書（PRD）

**バージョン**: v1  
**作成日**: 2025-12-17  
**作成者**: PdM  
**ステータス**: Draft  
**Tech Spec**: `tech_spec.md` を参照

---

## 1. 概要

### 1.1 背景

現在、BEサーバーを再起動するとデータが失われる問題がある。すべてのデータベースがインメモリ（Map）で実装されているため、サーバー再起動時にデータが消失する。

**問題の影響**:

- 開発中のデータが失われる
- テストが継続的に実行できない
- デモ・検証のためのデータが失われる
- 開発効率の低下

### 1.2 目的

BE再起動後もデータが保持されるようにし、開発環境でのデータ永続化を実現する。  
将来的に本番環境（PostgreSQL等）への移行も容易にする。

---

## 2. ユーザーストーリー

### US-1: 開発者として、BEサーバーを再起動してもデータが保持されるようにしたい

**理由**: 開発中のデータが失われると、開発効率が低下する

**受け入れ基準**:

- BEサーバーを再起動しても、以前に保存したデータが保持されている
- ユーザー情報、日報データ、目標データ、フォローアップデータがすべて保持される

### US-2: 開発者として、テストが継続的に実行できるようにしたい

**理由**: データが失われると、テストが継続的に実行できない

**受け入れ基準**:

- テスト実行後もデータが保持される
- 複数回のテスト実行でデータの整合性が保たれる

### US-3: 開発者として、デモ・検証のためのデータが保持されるようにしたい

**理由**: デモ・検証のためのデータが失われると、デモが困難になる

**受け入れ基準**:

- デモ・検証用のデータが保持される
- デモ時に以前のデータを参照できる

---

## 3. 機能要件

### 3.1 データ永続化

**要件**:

- BE再起動後もデータが保持される
- すべてのデータベース（users, daily_reports, goals, followups等）が永続化される
- データベースファイルは `apps/api/data/daily-report.db` に保存される（環境変数で変更可能）

**制約**:

- 既存のデータベースクラスのインターフェースを維持する
- 既存のAPIエンドポイントの動作に影響を与えない

### 3.2 データベース初期化

**要件**:

- BEサーバー起動時に自動的にデータベースファイルが作成される
- テーブルが存在しない場合は自動的に作成される
- インデックスが存在しない場合は自動的に作成される

### 3.3 パフォーマンス

**要件**:

- 既存のインメモリ実装と同等以上のパフォーマンスを維持する
- WALモードを有効化して同時書き込みのパフォーマンスを向上させる

### 3.4 エラーハンドリング

**要件**:

- データベースエラーが発生した場合、適切にエラーハンドリングする
- エラーメッセージをログに出力する
- ユーザーに分かりやすいエラーメッセージを返す

---

## 4. 非機能要件

### 4.1 セキュリティ

- データベースファイルへのアクセス制御
- パスワードハッシュ等の機密情報の適切な管理

### 4.2 パフォーマンス

- 既存のインメモリ実装と同等以上のパフォーマンス
- 大量データでのパフォーマンス維持

### 4.3 保守性

- 既存のコードへの影響を最小限に
- 段階的な移行が可能
- テストが容易

### 4.4 拡張性

- 将来的にPostgreSQL等への移行が容易
- SQL互換性により移行が容易

---

## 5. 技術要件

### 5.1 技術スタック

- **SQLite（better-sqlite3）**: ファイルベースのSQLデータベース
- **TypeScript**: 既存のコードベースと整合性を保つ

### 5.2 データベーススキーマ

- 既存のデータモデルをそのままSQLテーブルにマッピング
- 主キー: UUID（既存のIDをそのまま使用）
- 外部キー制約: データ整合性を保つ

### 5.3 移行戦略

- 段階的な移行: 1つのデータベースクラスから順次移行
- 既存のインターフェースを維持
- テストを追加して動作確認

---

## 6. 制約事項

### 6.1 技術的制約

- Zero to Oneフェーズ: 変更容易性を最優先とし、過度な抽象化は避ける
- 既存コードの維持: 既存のコードへの影響を最小限に

### 6.2 スケジュール制約

- 開発環境の改善: 即座に実装可能であること
- 本番環境への対応: 将来的に検討（具体的な時期は未定）

---

## 7. 成功基準

### 7.1 開発環境での成功基準

- ✅ BE再起動後もデータが保持される
- ✅ 開発中のデータが失われない
- ✅ テストが継続的に実行できる
- ✅ デモ・検証が容易になる

### 7.2 パフォーマンスの成功基準

- ✅ 既存のインメモリ実装と同等以上のパフォーマンス
- ✅ 大量データでのパフォーマンス維持

### 7.3 コード品質の成功基準

- ✅ 既存のコードへの影響が最小限
- ✅ テストカバレッジが維持または向上
- ✅ コードレビューで問題がない

---

## 8. アウトオブスコープ

### 8.1 本番環境への対応

- 本番環境（PostgreSQL等）への対応は将来的に検討
- 現時点では開発環境でのデータ永続化を優先

### 8.2 データマイグレーション

- 既存データの移行は不要（開発環境のため）
- 新規データベースファイルを使用

### 8.3 バックアップ機能

- データベースファイルのバックアップ機能は将来的に検討
- 現時点では手動バックアップを想定

---

## 9. リスクと対策

### 9.1 リスク

1. **SQLiteファイルの破損**
   - 影響: データ損失
   - 対策: WALモードの使用、定期的なバックアップ

2. **同時書き込みの制限**
   - 影響: パフォーマンス低下
   - 対策: WALモードの有効化、リトライロジック

3. **ネイティブモジュールのビルド問題**
   - 影響: セットアップの困難さ
   - 対策: Docker環境でのビルド、CI/CDでの確認

### 9.2 対策

- データベースファイルのバックアップ機能（将来的に実装）
- エラーハンドリングとリトライロジック
- ログ出力による問題の追跡

---

## 10. 次のステップ

1. **Tech Specレビュー**: Helperレビュー、PdMレビューを実施
2. **実装開始**: Tech Spec承認後、実装を開始
3. **段階的な移行**: 各データベースクラスを順次移行
4. **テスト追加**: ユニットテスト・統合テストを追加
5. **動作確認**: 実際のAPIエンドポイントで動作確認

---

## 11. 関連ドキュメント

- [技術リサーチ](./tech_research.md)
- [技術設計書](./tech_spec.md)
- [PdM判断材料](./pdm_decision_materials.md)
- [ロードマップ](../../general/roadmap.md)
- [バックログ](../../general/backlog.md)

---

**ステータス**: Approved  
**実装開始日**: 2025-12-17  
**次回レビュー予定**: 実装完了後
