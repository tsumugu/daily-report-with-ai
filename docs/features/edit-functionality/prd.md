# 編集機能 要件定義書（PRD）

**バージョン**: Phase 3-1  
**作成日**: 2025-01-XX  
**作成者**: PdM  
**ステータス**: Approved  
**承認日**: 2025-01-XX  
**承認者**: PdM（セルフレビュー完了）

---

## 1. 概要（Why）

### 背景

現在のシステムでは、日報やフォローアップを一度保存すると編集できない。ユーザーが誤入力や追記をしたい場合、新しい日報やフォローアップを追加するしかなく、記録の正確性が損なわれる可能性がある。

### 目的

- 入力した日報を後から編集できるようにし、記録の正確性を向上させる
- フォローアップのエピソードやアクションを編集できるようにし、記録の精度を高める
- 編集操作を直感的にし、ストレスなく修正できるようにする

---

## 2. ユーザーストーリー

### US-1: 日報の内容を編集したい

```
As a ユーザー
I want to 日報詳細画面から日報の内容を編集したい
So that 誤入力や追記を簡単に修正できる
```

### US-2: エピソードの内容を編集したい

```
As a ユーザー
I want to フォローアップ画面からエピソードの日付やメモを編集したい
So that 記録の精度を高められる
```

### US-3: アクションの内容を編集したい

```
As a ユーザー
I want to フォローアップ画面からアクションの日付やメモを編集したい
So that 記録の精度を高められる
```

### US-4: 編集後に自動的にステータスが更新される

```
As a ユーザー
I want to エピソードやアクションを編集した後にステータスが自動的に再計算される
So that ステータスの整合性が保たれる
```

---

## 3. 機能要件

### 3.1 日報の編集機能

#### 3.1.1 編集画面への遷移

| 項目           | 仕様                                                                 |
| :------------- | :------------------------------------------------------------------- |
| 編集ボタン配置 | 日報詳細画面のヘッダーに「編集する」ボタンを配置                     |
| 編集ボタン状態 | 現在は無効化されているが、Phase 3-1で有効化                          |
| 遷移先         | 日報編集画面（日報入力画面と同じフォーマット、既存データを読み込み） |

#### 3.1.2 編集可能な項目

| 項目              | 編集可否 | 説明                                      |
| :---------------- | :------- | :---------------------------------------- |
| 日付              | 編集可能 | 日報の日付を変更可能                      |
| できごと          | 編集可能 | できごとの内容を編集可能                  |
| 学び              | 編集可能 | 学びの内容を編集可能                      |
| よかったこと      | 編集可能 | よかったことの追加・編集・削除が可能      |
| 改善点/アクション | 編集可能 | 改善点/アクションの追加・編集・削除が可能 |

#### 3.1.3 編集画面の動作

| 項目           | 仕様                                          |
| :------------- | :-------------------------------------------- |
| 初期値の設定   | 既存の日報データをフォームに読み込む          |
| 保存処理       | 「保存」ボタンで更新APIを呼び出し、日報を更新 |
| キャンセル処理 | 「キャンセル」ボタンで日報詳細画面に戻る      |
| バリデーション | 日報入力画面と同じバリデーションルールを適用  |

#### 3.1.4 よかったこと・改善点の編集

| 項目           | 仕様                                       |
| :------------- | :----------------------------------------- |
| 追加           | 編集画面でよかったこと・改善点を追加可能   |
| 編集           | 既存のよかったこと・改善点の内容を編集可能 |
| 削除           | 既存のよかったこと・改善点を削除可能       |
| フォローアップ | 既存のフォローアップデータは維持される     |

### 3.2 フォローアップのエピソードとアクションの編集機能

#### 3.2.1 編集ボタンの配置

| 項目           | 仕様                                                                |
| :------------- | :------------------------------------------------------------------ |
| 編集ボタン配置 | フォローアップ画面の各エピソード/アクションカードに編集ボタンを配置 |
| ボタン位置     | 削除ボタンの近くに配置（右側）                                      |
| ボタンスタイル | アイコンボタン（編集アイコン）                                      |

#### 3.2.2 編集可能な項目

| 項目 | 編集可否 | 説明                        |
| :--- | :------- | :-------------------------- |
| 日付 | 編集可能 | 再現日/完了日を変更可能     |
| メモ | 編集可能 | 再現メモ/進捗メモを編集可能 |

#### 3.2.3 編集画面の動作

| 項目           | 仕様                                                                |
| :------------- | :------------------------------------------------------------------ |
| 編集方法       | 編集ボタンクリックで編集モーダルを表示                              |
| 初期値の設定   | 既存のエピソード/アクションデータをフォームに読み込む               |
| 保存処理       | 「保存」ボタンで更新APIを呼び出し、エピソード/アクションを更新      |
| キャンセル処理 | 「キャンセル」ボタンまたは×ボタンでモーダルを閉じる                 |
| バリデーション | 追加時と同じバリデーションルールを適用（日付必須、メモ500文字以内） |

#### 3.2.4 ステータスの自動再計算

| 項目             | 仕様                                                                      |
| :--------------- | :------------------------------------------------------------------------ |
| 再計算タイミング | エピソード/アクションの編集・削除後に自動的にステータスを再計算           |
| 再計算ロジック   | 既存のステータス自動判定ロジックを使用（エピソード/アクション数に基づく） |
| ステータス表示   | 再計算後のステータスを画面に反映                                          |

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 編集画面の読み込みは1秒以内に完了すること
- 編集保存は1秒以内に完了すること
- ステータス再計算は即座に反映されること

### 4.2 データ整合性

- 編集後、関連するデータ（フォローアップ、週次フォーカス等）との整合性を保つこと
- エピソード/アクション編集後、ステータスが自動的に再計算されること
- 日報編集後、関連するフォローアップデータが維持されること

### 4.3 UI/UX

- 編集操作が直感的で、ストレスなく完了できること
- 編集画面と入力画面のUIを統一し、一貫性を保つこと
- 編集ボタンが適切な位置に配置され、見つけやすいこと

---

## 5. エッジケースの洗い出し

### エラー発生時のフロー

| ケース                                     | 対応                                                                        |
| :----------------------------------------- | :-------------------------------------------------------------------------- |
| ネットワークエラー                         | エラーメッセージを表示し、リトライボタンを提供                              |
| 認証切れ                                   | ログイン画面へリダイレクト                                                  |
| サーバーエラー（500）                      | 「エラーが発生しました。しばらく経ってから再試行してください」と表示        |
| 日報が見つからない（404）                  | 「日報が見つかりません」と表示し、一覧画面へ戻る                            |
| エピソード/アクションが見つからない（404） | 「エピソード/アクションが見つかりません」と表示し、フォローアップ画面を更新 |

### 例外的な操作フロー

| ケース                          | 対応                                                                 |
| :------------------------------ | :------------------------------------------------------------------- |
| 編集途中でブラウザを閉じる      | 確認ダイアログを表示（「編集内容が失われますが、よろしいですか？」） |
| 編集画面で日付を変更する        | 日付変更後、関連するフォローアップデータは維持される                 |
| よかったこと/改善点を削除する   | 削除確認ダイアログを表示（「この項目を削除しますか？」）             |
| エピソード/アクションを削除する | 削除確認なしで即座に削除（既存の削除機能と同じ）                     |

### 境界値・限界値

| ケース                         | 対応                                       |
| :----------------------------- | :----------------------------------------- |
| 文字数上限（できごと・学び）   | 1000文字以内（既存のバリデーションと同じ） |
| メモの文字数上限               | 500文字以内（既存のバリデーションと同じ）  |
| よかったこと・改善点の件数上限 | 制限なし（既存の仕様と同じ）               |

---

## 6. メッセージ仕様

### エラーメッセージ

| 状況                                | メッセージ                                                     |
| :---------------------------------- | :------------------------------------------------------------- |
| ネットワークエラー                  | 「通信エラーが発生しました。再試行してください」               |
| サーバーエラー                      | 「エラーが発生しました。しばらく経ってから再試行してください」 |
| 日報が見つからない                  | 「日報が見つかりません」                                       |
| エピソード/アクションが見つからない | 「エピソード/アクションが見つかりません」                      |
| バリデーションエラー（日付）        | 「日付は必須です」                                             |
| バリデーションエラー（文字数）      | 「メモは500文字以内で入力してください」                        |

### 成功メッセージ

| 操作           | メッセージ                     |
| :------------- | :----------------------------- |
| 日報更新       | 「日報を更新しました」         |
| エピソード更新 | 「エピソードを更新しました」   |
| アクション更新 | 「アクションを更新しました」   |
| ステータス更新 | 「ステータスが更新されました」 |

### 確認メッセージ

| 操作                          | メッセージ                                           |
| :---------------------------- | :--------------------------------------------------- |
| 編集途中でブラウザを閉じる    | 「編集内容が失われますが、よろしいですか？」         |
| よかったこと/改善点を削除する | 「この項目を削除しますか？削除すると元に戻せません」 |

---

## 7. 画面遷移図

### 7.1 日報編集のフロー

```
日報詳細画面
  ↓ 「編集する」ボタンクリック
日報編集画面（既存データを読み込み）
  ↓ 「保存」ボタンクリック
日報更新API呼び出し
  ↓ 成功
日報詳細画面（更新後のデータを表示）
  ↓ または「キャンセル」ボタンクリック
日報詳細画面（変更なし）
```

### 7.2 エピソード/アクション編集のフロー

```
フォローアップ画面
  ↓ エピソード/アクションカードの「編集」ボタンクリック
編集モーダル（既存データを読み込み）
  ↓ 「保存」ボタンクリック
エピソード/アクション更新API呼び出し
  ↓ 成功
ステータス自動再計算
  ↓
フォローアップ画面（更新後のデータを表示）
  ↓ または「キャンセル」ボタン/×ボタンクリック
フォローアップ画面（変更なし）
```

---

## 8. ビジネスルール

### 8.1 日報編集のルール

- **編集権限**: 日報の作成者のみが編集可能
- **日付変更**: 日付を変更しても、関連するフォローアップデータは維持される
- **よかったこと/改善点の削除**: 削除時は確認ダイアログを表示
- **フォローアップデータ**: 日報編集後も、既存のフォローアップデータは維持される

### 8.2 エピソード/アクション編集のルール

- **編集権限**: エピソード/アクションの作成者のみが編集可能
- **ステータス再計算**: 編集・削除後に自動的にステータスを再計算
- **削除**: 削除確認なしで即座に削除（既存の削除機能と同じ）
- **日付変更**: 日付を変更しても、ステータス判定ロジックに影響しない（エピソード/アクション数に基づく）

### 8.3 ステータス自動再計算のルール

- **再計算タイミング**: エピソード/アクションの追加・編集・削除後に自動的に再計算
- **再計算ロジック**: 既存のステータス自動判定ロジックを使用
  - よかったこと: エピソード数 = 0 → 未着手、1件以上 → 進行中、3件以上 → 再現成功
  - 改善点: アクション数 = 0 → 未着手、1件以上 → 進行中、3件以上 → 完了

---

## 9. 成功基準

- ユーザーが日報の内容を簡単に編集できる
- ユーザーがエピソード/アクションの内容を簡単に編集できる
- 編集操作が直感的で、ストレスなく完了できる
- 編集後、ステータスが自動的に再計算される
- 編集画面と入力画面のUIが統一されている

---

## 10. 受入基準（AC）

### AC-1: 日報の編集ができる

- Given: 日報詳細画面が表示されている
- When: 「編集する」ボタンをクリックする
- Then: 日報編集画面が表示され、既存の日報データがフォームに読み込まれる

### AC-2: 日報の内容を更新できる

- Given: 日報編集画面で内容を変更している
- When: 「保存」ボタンをクリックする
- Then: 日報が更新され、日報詳細画面に更新後のデータが表示される

### AC-3: エピソードの編集ができる

- Given: フォローアップ画面が表示されている
- When: エピソードカードの「編集」ボタンをクリックする
- Then: 編集モーダルが表示され、既存のエピソードデータがフォームに読み込まれる

### AC-4: エピソードの内容を更新できる

- Given: 編集モーダルでエピソードの内容を変更している
- When: 「保存」ボタンをクリックする
- Then: エピソードが更新され、ステータスが自動的に再計算される

### AC-5: アクションの編集ができる

- Given: フォローアップ画面が表示されている
- When: アクションカードの「編集」ボタンをクリックする
- Then: 編集モーダルが表示され、既存のアクションデータがフォームに読み込まれる

### AC-6: アクションの内容を更新できる

- Given: 編集モーダルでアクションの内容を変更している
- When: 「保存」ボタンをクリックする
- Then: アクションが更新され、ステータスが自動的に再計算される

### AC-7: ステータスが自動的に再計算される

- Given: エピソード/アクションを編集または削除した
- When: 保存または削除が完了する
- Then: ステータスが自動的に再計算され、画面に反映される

---

## 11. 他ロールへの依頼

### To Eng

- `tech_spec.md` で以下を定義してください：
  - 日報更新APIの設計（PUT /api/daily-reports/:id）
  - エピソード/アクション更新APIの設計（PUT /api/good-points/:id/followups/:followupId、PUT /api/improvements/:id/followups/:followupId）
  - ステータス自動再計算の実装方針
  - データ整合性の確保方法
  - パフォーマンス最適化方針

### To Des

- `ui_design.md` で以下を定義してください：
  - 日報編集画面のUI設計（日報入力画面との統一性を考慮）
  - エピソード/アクション編集モーダルのUI設計
  - 編集ボタンの配置とデザイン
  - 編集画面と入力画面のUI統一方法
  - 確認ダイアログのデザイン

---

## 12. 関連ドキュメント

| ドキュメント                                      | 説明                             |
| :------------------------------------------------ | :------------------------------- |
| `docs/features/daily-report-input/prd.md`         | 日報入力機能のPRD                |
| `docs/features/daily-report-input/ui_design.md`   | 日報入力機能のUI設計書           |
| `docs/features/followup-enhancement/prd.md`       | フォローアップ動作改善のPRD      |
| `docs/features/followup-enhancement/ui_design.md` | フォローアップ動作改善のUI設計書 |
| `docs/general/roadmap.md`                         | プロダクトロードマップ           |

---

## 13. Phase分け

### Phase 3-1（MVP）

- ✅ 日報の編集機能
- ✅ エピソード/アクションの編集機能
- ✅ ステータス自動再計算機能

### 将来実装（Phase 3以降）

- 編集履歴の保持
- 編集の差分表示
- 一括編集機能
- 編集権限の詳細設定

---

_本PRDは Approved ステータスです。セルフレビュー完了。Tech Spec作成に進むことができます。_
