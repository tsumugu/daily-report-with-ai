# 編集機能 技術リサーチ（Tech Research）

## 1. PRD要求サマリ

- 日報の編集機能（日付、できごと、学び、よかったこと、改善点/アクション）
- エピソード/アクションの編集機能（日付、メモ）
- 編集後のステータス自動再計算
- データ整合性の維持（フォローアップデータの保持）

---

## 2. 一般的な実現方法

### 2.1 REST API設計パターン

| パターン                       | 特徴                         | 適用ケース                     |
| :----------------------------- | :--------------------------- | :----------------------------- |
| **PUT（完全置換）**            | リソース全体を置き換える     | シンプルな更新、冪等性が重要   |
| **PATCH（部分更新）**          | 変更されたフィールドのみ更新 | 柔軟な更新、部分的な変更が多い |
| **POST（カスタムアクション）** | 特定のアクションを実行       | 複雑なビジネスロジック         |

### 2.2 更新APIのベストプラクティス

#### バリデーション

- **クライアント側**: 即座のフィードバック、UX向上
- **サーバー側**: セキュリティ、データ整合性の保証
- **両方で実施**: クライアント側はUX、サーバー側はセキュリティ

#### 楽観的ロック

- **バージョン番号**: `updatedAt`や`version`フィールドで競合検出
- **ETag**: HTTPヘッダーでリソースのバージョン管理
- **適用**: 同時編集の可能性がある場合に有効

#### トランザクション

- **一括更新**: 日報 + よかったこと + 改善点を一括更新
- **ロールバック**: エラー時にすべての変更を元に戻す
- **整合性**: 関連データの整合性を保つ

### 2.3 ステータス自動再計算

#### 再計算タイミング

- **即座に再計算**: 更新後すぐにステータスを再計算
- **バッチ処理**: 定期的にバッチで再計算（パフォーマンス重視）
- **推奨**: 即座に再計算（UX向上、データ整合性）

#### 再計算ロジック

- **既存ロジックの再利用**: エピソード/アクション数に基づく判定
- **閾値ベース**: 3回以上でステータス変更
- **拡張性**: 将来的に閾値を変更可能にする設計

---

## 3. 類似サービスの技術構成

| サービス          | 更新方式  | 特徴                       |
| :---------------- | :-------- | :------------------------- |
| **Notion**        | PATCH API | 部分更新、楽観的ロック     |
| **Google Docs**   | 差分更新  | リアルタイム編集、競合解決 |
| **GitHub Issues** | PATCH API | 部分更新、履歴管理         |

---

## 4. 推奨構成（本プロジェクト向け）

### データモデル

- **既存モデルの活用**: DailyReport、GoodPoint、Improvement、Followupモデルをそのまま使用
- **updatedAtの自動更新**: 更新時に`updatedAt`を自動的に更新
- **データ整合性**: フォローアップデータは維持される

### API設計

- **PUT /api/daily-reports/:id**: 日報の完全更新（RESTful）
- **PUT /api/good-points/:id/followups/:followupId**: エピソードの更新
- **PUT /api/improvements/:id/followups/:followupId**: アクションの更新
- **ステータス自動再計算**: エピソード/アクション更新後に自動実行

### バリデーション

- **クライアント**: Angular Reactive Forms（既存と同じ）
- **サーバー**: 既存のバリデーション関数を再利用
- **エラーハンドリング**: 既存のエラーハンドリングパターンを踏襲

### パフォーマンス

- **インメモリDB**: 既存のインメモリDBを使用（高速）
- **再計算の最適化**: エピソード/アクション数のカウントを最適化
- **レスポンス時間**: 1秒以内を目標

---

## 5. 実装上の考慮事項

### 5.1 データ整合性

- **フォローアップデータの維持**: 日報編集後も、既存のフォローアップデータは維持される
- **関連データの整合性**: よかったこと/改善点を削除した場合、フォローアップデータの扱いを明確にする
- **日付変更の影響**: 日報の日付を変更しても、フォローアップデータは維持される

### 5.2 エラーハンドリング

- **404エラー**: リソースが見つからない場合
- **403エラー**: 編集権限がない場合
- **400エラー**: バリデーションエラー
- **500エラー**: サーバーエラー

### 5.3 セキュリティ

- **認証**: 既存の認証ミドルウェアを使用
- **認可**: 作成者のみが編集可能
- **入力検証**: サーバー側で必ず検証

---

## 6. 参考資料

- REST API Design Best Practices
- HTTP PUT vs PATCH
- Optimistic Locking Patterns
- Transaction Management in REST APIs
