# テスト戦略

**機能名**: 日報と目標の関連付け機能
**作成日**: 2025-12-16
**作成者**: QA
**ステータス**: Approved

---

## 1. テストレイヤ選択

### 1.1. 判断プロセス

BL-03（日報と目標の関連付け機能）のテストレイヤを以下の判断基準で選択します：

| 判断質問                         | 該当 | 選択するテストレイヤ |
| -------------------------------- | ---- | -------------------- |
| ビジネスルール・計算・状態遷移か | ○    | Unit                 |
| 複数モジュール・外部依存の連携か | ○    | Integration          |
| 他チーム・外部とのI/Fか          | -    | Contract             |
| ユーザー操作の一連の流れか       | ○    | E2E                  |

**結論**: この機能は、ビジネスルール（関連付けのバリデーション）、複数モジュールの連携（API、データベース、UI）、ユーザー操作（日報作成・編集時の目標選択）のすべてに該当するため、**Unit、Integration、E2Eのすべてのレイヤでテストを実施**します。

ただし、**可能な限り下位レイヤで担保**する原則に従い、以下の優先順位でテストを配置します：

1. **Unitテスト**: ビジネスルール、バリデーション、データベース操作
2. **Integrationテスト**: API、複数モジュールの連携
3. **E2Eテスト**: ユーザー操作の一連の流れ（クリティカルパスのみ）

---

## 2. Unitテスト戦略

### 2.1. テスト対象

#### 2.1.1. バックエンド

**DailyReportGoalsDatabase**:

- `save()`: 日報と目標の関連付けを保存
- `findByDailyReportId()`: 日報IDから関連目標を取得
- `findByGoalId()`: 目標IDから関連日報を取得
- `findByDailyReportIds()`: 複数の日報IDから関連目標を一括取得（N+1問題回避）
- `deleteByDailyReportId()`: 日報IDに関連する関連付けを削除
- `exists()`: 関連付けが存在するか確認

**バリデーションロジック**:

- `validateGoalIds()`: 目標IDのバリデーション
  - UUID形式チェック
  - 目標の存在チェック
  - 所有権チェック
  - 関連付け可能な目標数の上限チェック（最大10個）

#### 2.1.2. フロントエンド

**GoalSelectField コンポーネント**:

- 目標が正しく表示されること
- 複数選択が可能なこと
- 選択された目標がチップ形式で表示されること
- 削除ボタンが正しく動作すること

**GoalChip コンポーネント**:

- 目標名が正しく表示されること
- クリック時に目標詳細画面に遷移すること（ルーティング）
- 削除ボタンが正しく動作すること（編集時）

**RelatedDailyReportsList コンポーネント**:

- 関連日報が正しく表示されること
- 並び替えが正しく動作すること
- 「もっと見る」ボタンが正しく動作すること
- 空状態が正しく表示されること

### 2.2. テスト観点

#### 正常系

- 日報と目標を正しく関連付けられること
- 複数の目標を関連付けられること
- 関連付けなしでも日報を作成できること

#### 異常系

- 無効な目標ID（UUID形式でない）が指定された場合、エラーが返ること
- 存在しない目標IDが指定された場合、エラーが返ること
- アクセス権限のない目標IDが指定された場合、エラーが返ること
- 関連付け可能な目標数の上限（最大10個）を超えた場合、エラーが返ること

#### エッジケース

- 削除された目標に関連付けられた日報を取得した場合、削除された目標は除外されること
- 日報を削除した場合、関連付けデータも削除されること

### 2.3. カバレッジ対象

- `DailyReportGoalsDatabase` クラスのすべてのメソッド: 100%
- バリデーションロジック: 100%
- フロントエンドコンポーネント: 100%（DOM構造ではなく、ロジックと振る舞い）

---

## 3. Integrationテスト戦略

### 3.1. テスト対象

#### 3.1.1. 日報作成API

- `POST /api/daily-reports` に `goalIds` を指定して日報を作成
- 関連付けデータが正しく保存されること
- レスポンスに目標情報が含まれること

#### 3.1.2. 日報更新API

- `PUT /api/daily-reports/:id` に `goalIds` を指定して日報を更新
- 既存の関連付けが削除され、新しい関連付けが作成されること
- レスポンスに更新された目標情報が含まれること

#### 3.1.3. 日報取得API

- `GET /api/daily-reports/:id` で日報を取得
- レスポンスに関連目標情報が含まれること
- 削除された目標は除外されること

#### 3.1.4. 日報一覧取得API

- `GET /api/daily-reports` で日報一覧を取得
- 各日報に関連目標情報が含まれること
- N+1問題が発生しないこと（`findByDailyReportIds()` を使用）

#### 3.1.5. 目標詳細取得API

- `GET /api/goals/:id` で目標詳細を取得
- レスポンスに関連日報情報が含まれること
- ページネーション（`limit`, `offset`）が正しく動作すること
- 並び替え（`sort`）が正しく動作すること

### 3.2. テスト観点

#### 正常系

- 日報作成・更新時に目標を関連付け、正しく保存されること
- 日報取得時に関連目標情報が含まれること
- 目標取得時に関連日報情報が含まれること

#### 異常系

- 無効な目標IDを指定した場合、400 Bad Request が返ること
- アクセス権限のない目標IDを指定した場合、403 Forbidden が返ること

#### エッジケース

- 日報を削除した場合、関連付けデータも削除されること
- 削除された目標に関連付けられた日報を取得した場合、削除された目標は除外されること

---

## 4. E2Eテスト戦略

### 4.1. E2Eテストの必要性判断

以下の基準でE2Eテストの必要性を判断します：

| 基準                                               | 判定 |
| -------------------------------------------------- | ---- |
| 実ユーザーが行う操作であるか                       | ○    |
| 壊れた場合の影響が大きいか                         | ○    |
| 他レイヤで十分に担保できないか                     | ○    |
| 最短経路のみを検証しているか                       | ○    |
| 複数機能を1テストに詰め込んでいないか              | ○    |
| 不安定要因（時間待ち・共有データ）を含めていないか | ○    |

**結論**: 日報作成・編集時の目標選択は、実ユーザーが行う重要な操作であり、壊れた場合の影響が大きいため、**E2Eテストを実施する**ことを推奨します。

ただし、**クリティカルパスのみ**をテストし、すべてのエッジケースをE2Eで担保することは避けます。

### 4.2. E2Eテスト対象（クリティカルパスのみ）

#### 4.2.1. US-1: 日報作成時の目標関連付け

**シナリオ**:

1. 日報作成画面を開く
2. 目標を選択する（1つ）
3. 日報を作成する
4. 日報一覧で、選択した目標が表示されることを確認

**優先度**: 高（クリティカルパス）

#### 4.2.2. US-2: 日報編集時の目標関連付けの変更

**シナリオ**:

1. 既存の日報を開く
2. 編集ボタンをクリック
3. 目標を追加・削除する
4. 日報を更新する
5. 日報詳細で、更新された目標が表示されることを確認

**優先度**: 高（クリティカルパス）

#### 4.2.3. US-3: 日報一覧での目標表示

**シナリオ**:

1. 日報一覧を開く
2. 各日報に関連目標がチップ形式で表示されることを確認
3. 目標チップをクリックして、目標詳細画面に遷移することを確認

**優先度**: 中（UI表示の確認、Unitテストで一部担保）

#### 4.2.4. US-4: 目標詳細画面での関連日報表示

**シナリオ**:

1. 目標詳細画面を開く
2. 関連日報が一覧表示されることを確認
3. 日報をクリックして、日報詳細画面に遷移することを確認

**優先度**: 中（UI表示の確認、Integrationテストで一部担保）

### 4.3. E2Eテストで担保しないもの

以下は、Unit/IntegrationテストでE2Eテスト戦略

**機能名**: 日報と目標の関連付け機能
**作成日**: 2025-12-16
**作成者**: QA
**ステータス**: Approved

---

## 1. テストレイヤ選択

### 1.1. 判断プロセス

BL-03（日報と目標の関連付け機能）のテストレイヤを以下の判断基準で選択します：

| 判断質問                         | 該当 | 選択するテストレイヤ |
| -------------------------------- | ---- | -------------------- |
| ビジネスルール・計算・状態遷移か | ○    | Unit                 |
| 複数モジュール・外部依存の連携か | ○    | Integration          |
| 他チーム・外部とのI/Fか          | -    | Contract             |
| ユーザー操作の一連の流れか       | ○    | E2E                  |

**結論**: この機能は、ビジネスルール（関連付けのバリデーション）、複数モジュールの連携（API、データベース、UI）、ユーザー操作（日報作成・編集時の目標選択）のすべてに該当するため、**Unit、Integration、E2Eのすべてのレイヤでテストを実施**します。

ただし、**可能な限り下位レイヤで担保**する原則に従い、以下の優先順位でテストを配置します：

1. **Unitテスト**: ビジネスルール、バリデーション、データベース操作
2. **Integrationテスト**: API、複数モジュールの連携
3. **E2Eテスト**: ユーザー操作の一連の流れ（クリティカルパスのみ）

---

## 2. Unitテスト戦略

### 2.1. テスト対象

#### 2.1.1. バックエンド

**DailyReportGoalsDatabase**:

- `save()`: 日報と目標の関連付けを保存
- `findByDailyReportId()`: 日報IDから関連目標を取得
- `findByGoalId()`: 目標IDから関連日報を取得
- `findByDailyReportIds()`: 複数の日報IDから関連目標を一括取得（N+1問題回避）
- `deleteByDailyReportId()`: 日報IDに関連する関連付けを削除
- `exists()`: 関連付けが存在するか確認

**バリデーションロジック**:

- `validateGoalIds()`: 目標IDのバリデーション
  - UUID形式チェック
  - 目標の存在チェック
  - 所有権チェック
  - 関連付け可能な目標数の上限チェック（最大10個）

#### 2.1.2. フロントエンド

**GoalSelectField コンポーネント**:

- 目標が正しく表示されること
- 複数選択が可能なこと
- 選択された目標がチップ形式で表示されること
- 削除ボタンが正しく動作すること

**GoalChip コンポーネント**:

- 目標名が正しく表示されること
- クリック時に目標詳細画面に遷移すること（ルーティング）
- 削除ボタンが正しく動作すること（編集時）

**RelatedDailyReportsList コンポーネント**:

- 関連日報が正しく表示されること
- 並び替えが正しく動作すること
- 「もっと見る」ボタンが正しく動作すること
- 空状態が正しく表示されること

### 2.2. テスト観点

#### 正常系

- 日報と目標を正しく関連付けられること
- 複数の目標を関連付けられること
- 関連付けなしでも日報を作成できること

#### 異常系

- 無効な目標ID（UUID形式でない）が指定された場合、エラーが返ること
- 存在しない目標IDが指定された場合、エラーが返ること
- アクセス権限のない目標IDが指定された場合、エラーが返ること
- 関連付け可能な目標数の上限（最大10個）を超えた場合、エラーが返ること

#### エッジケース

- 削除された目標に関連付けられた日報を取得した場合、削除された目標は除外されること
- 日報を削除した場合、関連付けデータも削除されること

### 2.3. カバレッジ対象

- `DailyReportGoalsDatabase` クラスのすべてのメソッド: 100%
- バリデーションロジック: 100%
- フロントエンドコンポーネント: 100%（DOM構造ではなく、ロジックと振る舞い）

---

## 3. Integrationテスト戦略

### 3.1. テスト対象

#### 3.1.1. 日報作成API

- `POST /api/daily-reports` に `goalIds` を指定して日報を作成
- 関連付けデータが正しく保存されること
- レスポンスに目標情報が含まれること

#### 3.1.2. 日報更新API

- `PUT /api/daily-reports/:id` に `goalIds` を指定して日報を更新
- 既存の関連付けが削除され、新しい関連付けが作成されること
- レスポンスに更新された目標情報が含まれること

#### 3.1.3. 日報取得API

- `GET /api/daily-reports/:id` で日報を取得
- レスポンスに関連目標情報が含まれること
- 削除された目標は除外されること

#### 3.1.4. 日報一覧取得API

- `GET /api/daily-reports` で日報一覧を取得
- 各日報に関連目標情報が含まれること
- N+1問題が発生しないこと（`findByDailyReportIds()` を使用）

#### 3.1.5. 目標詳細取得API

- `GET /api/goals/:id` で目標詳細を取得
- レスポンスに関連日報情報が含まれること
- ページネーション（`limit`, `offset`）が正しく動作すること
- 並び替え（`sort`）が正しく動作すること

### 3.2. テスト観点

#### 正常系

- 日報作成・更新時に目標を関連付け、正しく保存されること
- 日報取得時に関連目標情報が含まれること
- 目標取得時に関連日報情報が含まれること

#### 異常系

- 無効な目標IDを指定した場合、400 Bad Request が返ること
- アクセス権限のない目標IDを指定した場合、403 Forbidden が返ること

#### エッジケース

- 日報を削除した場合、関連付けデータも削除されること
- 削除された目標に関連付けられた日報を取得した場合、削除された目標は除外されること

---

## 4. E2Eテスト戦略

### 4.1. E2Eテストの必要性判断

以下の基準でE2Eテストの必要性を判断します：

| 基準                                               | 判定 |
| -------------------------------------------------- | ---- |
| 実ユーザーが行う操作であるか                       | ○    |
| 壊れた場合の影響が大きいか                         | ○    |
| 他レイヤで十分に担保できないか                     | ○    |
| 最短経路のみを検証しているか                       | ○    |
| 複数機能を1テストに詰め込んでいないか              | ○    |
| 不安定要因（時間待ち・共有データ）を含めていないか | ○    |

**結論**: 日報作成・編集時の目標選択は、実ユーザーが行う重要な操作であり、壊れた場合の影響が大きいため、**E2Eテストを実施する**ことを推奨します。

ただし、**クリティカルパスのみ**をテストし、すべてのエッジケースをE2Eで担保することは避けます。

### 4.2. E2Eテスト対象（クリティカルパスのみ）

#### 4.2.1. US-1: 日報作成時の目標関連付け

**シナリオ**:

1. 日報作成画面を開く
2. 目標を選択する（1つ）
3. 日報を作成する
4. 日報一覧で、選択した目標が表示されることを確認

**優先度**: 高（クリティカルパス）

#### 4.2.2. US-2: 日報編集時の目標関連付けの変更

**シナリオ**:

1. 既存の日報を開く
2. 編集ボタンをクリック
3. 目標を追加・削除する
4. 日報を更新する
5. 日報詳細で、更新された目標が表示されることを確認

**優先度**: 高（クリティカルパス）

#### 4.2.3. US-3: 日報一覧での目標表示

**シナリオ**:

1. 日報一覧を開く
2. 各日報に関連目標がチップ形式で表示されることを確認
3. 目標チップをクリックして、目標詳細画面に遷移することを確認

**優先度**: 中（UI表示の確認、Unitテストで一部担保）

#### 4.2.4. US-4: 目標詳細画面での関連日報表示

**シナリオ**:

1. 目標詳細画面を開く
2. 関連日報が一覧表示されることを確認
3. 日報をクリックして、日報詳細画面に遷移することを確認

**優先度**: 中（UI表示の確認、Integrationテストで一部担保）

### 4.3. E2Eテストで担保しないもの

以下は、Unit/Integrationテストで担保するため、E2Eテストでは実施しません：

- 無効な目標IDを指定した場合のエラーハンドリング（Unitテストで担保）
- 関連付け可能な目標数の上限チェック（Unitテストで担保）
- 削除された目標の除外処理（Integrationテストで担保）
- 日報削除時の関連付けデータ削除（Integrationテストで担保）
- ページネーション・並び替えの詳細なロジック（Integrationテストで担保）

---

## 5. カバレッジ監視

### 5.1. カバレッジの目的

カバレッジは品質劣化の兆候を検知するための指標として利用します。数値を上げること自体を目的にテストを追加することは避けます。

### 5.2. カバレッジ対象

- `DailyReportGoalsDatabase` クラス: 100%
- バリデーションロジック: 100%
- API（日報作成・更新、目標詳細取得）: 100%
- フロントエンドコンポーネント: 100%（ロジックと振る舞いのみ、DOM構造は除く）

### 5.3. カバレッジ対象外として扱ってよいもの

- DOM構造のみの記述
- CSS・アニメーション・スタイル切替
- 表示専用のラッパーコンポーネント

---

## 6. テスト実装の優先順位

Phase 1では、以下の優先順位でテストを実装します：

1. **Unitテスト**（必須）
   - `DailyReportGoalsDatabase` クラスのすべてのメソッド
   - バリデーションロジック
   - フロントエンドコンポーネント

2. **Integrationテスト**（必須）
   - 日報作成・更新API
   - 日報取得・一覧取得API
   - 目標詳細取得API

3. **E2Eテスト**（クリティカルパスのみ）
   - US-1: 日報作成時の目標関連付け（必須）
   - US-2: 日報編集時の目標関連付けの変更（必須）
   - US-3, US-4: UI表示の確認（推奨）

---

## 7. テスト実装のガイドライン

### 7.1. TDD（Test-Driven Development）の実践

本プロジェクトでは、t-wada提唱のred-green TDDを実践します：

1. **Red**: 失敗するテストを書く
2. **Green**: テストがpassする最小限の実装を書く
3. **Refactor**: テストがGreenを維持している状態で、リファクタする

### 7.2. テストの安定性

- E2Eテストは不安定要因（時間待ち、共有データ）を避ける
- テストデータは各テストで独立して準備する
- テスト間の依存関係を避ける

### 7.3. テストの可読性

- テスト名は「何を」「どうすると」「どうなる」の形式で記述する
- テストは1つの意図のみを検証する
- アサーションは明確で具体的に記述する

---

## 8. 承認

テスト戦略は適切に策定されています。Phase 1では、Unit、Integration、E2E（クリティカルパスのみ）のすべてのレイヤでテストを実施し、品質を保証します。

**承認日**: 2025-12-16
**承認者**: QA

次のステップ（Desによる UI Design作成）に進むことを承認します。

---

_本テスト戦略は、BL-03（日報と目標の関連付け機能）の品質保証方針を定義したものです。_
