# 日報と目標の関連付け機能 PRD

**バージョン**: v1
**作成日**: 2025-12-16
**作成者**: PdM
**ステータス**: Approved
**承認日**: 2025-12-16
**承認者**: PdM

---

## 1. 概要（Why）

### 背景

現在、日報と目標は個別に管理されており、「この日報がどの目標のために記録されたか」という関連性が不明確になっている。目標階層管理機能（BL-01）が実装され、目標を階層的に管理できるようになったが、日々の活動（日報）と目標の紐づけができていないため、目標達成への道筋が見えない状態になっている。

また、半期や四半期での振り返りの際、「この目標のために何をしたか」を確認するには、複数の画面を行き来して手動でデータを探す必要があり、振り返りに多くの時間を費やしている。

### 目的

- 日報と目標を関連付けることで、日々の活動が目標達成にどう貢献しているかを明確にする
- 関連付けの負担を軽減する仕組みを提供し、ユーザーが自然に使える機能にする
- 目標ごとに日報を集約して表示できるようにし、振り返りを効率化する
- 後続機能（BL-06: 目標別取り組み集約表示、BL-07: アクティビティタイムライン）の前提条件を満たす

### Phase分け

| 機能                                     | Phase 1 | Phase 2 | 将来 |
| :--------------------------------------- | :------ | :------ | :--- |
| 日報作成時の目標関連付け（任意）         | ✅      | -       | -    |
| 日報編集時の目標関連付けの追加・編集     | ✅      | -       | -    |
| 複数目標への関連付け                     | ✅      | -       | -    |
| 目標階層構造との整合性                   | ✅      | -       | -    |
| 目標ごとの日報一覧表示                   | ✅      | -       | -    |
| 自動関連付けの提案（週次フォーカス連携） | -       | ✅      | -    |
| キーワードベースの自動関連付け提案       | -       | ✅      | -    |
| 目標ごとの貢献度定量化                   | -       | -       | ✅   |

---

## 2. ユーザーストーリー

### US-1: 日報作成時の目標関連付け

```
As a ユーザー
I want to 日報を作成する際に、関連する目標を選択したい
So that 日々の活動が目標達成にどう貢献しているか明確にできる
```

**受け入れ基準**:

- 日報作成画面で、関連する目標を選択できる（任意）
- 複数の目標を選択できる
- 目標を選択しなくても日報を作成できる（関連付けは任意）
- 選択した目標が日報作成画面に表示される

### US-2: 日報編集時の目標関連付けの変更

```
As a ユーザー
I want to 日報を編集する際に、関連付けられた目標を追加・変更・削除したい
So that 記録後に目標との関連性を調整できる
```

**受け入れ基準**:

- 日報編集画面で、関連付けられた目標を確認できる
- 関連付けられた目標を追加・削除できる
- 目標の関連付けを変更しても、他のフィールドに影響しない

### US-3: 日報一覧での目標表示

```
As a ユーザー
I want to 日報一覧で、各日報に関連付けられた目標を確認したい
So that どの日報がどの目標に貢献しているか一目で分かる
```

**受け入れ基準**:

- 日報一覧で、各日報に関連付けられた目標が表示される
- 目標が複数ある場合は、すべて表示される
- 目標が関連付けられていない日報は、空状態を表示する

### US-4: 目標詳細画面での関連日報表示

```
As a ユーザー
I want to 目標詳細画面で、その目標に関連付けられた日報を確認したい
So that 目標に対してどのような活動をしてきたか振り返ることができる
```

**受け入れ基準**:

- 目標詳細画面で、その目標に関連付けられた日報が一覧表示される
- 日報は時系列（新しい順/古い順）で並び替えられる
- 関連日報の総数が表示される
- 日報をクリックすると、日報詳細画面に遷移できる

### US-5: 目標階層構造との整合性

```
As a ユーザー
I want to 日報を任意の階層レベルの目標に関連付けたい
So that 柔軟に目標と日報の関連性を管理できる
```

**受け入れ基準**:

- 長期目標、中期目標、短期目標のいずれにも日報を関連付けられる
- 目標選択時に、目標の階層構造が視覚的に表現される
- どの階層レベルの目標に関連付けられているか明確に分かる

---

## 3. 機能要件

### 3.1 日報と目標の関連付け

#### 3.1.1 日報作成時の目標選択

| 項目               | 仕様                                                                |
| :----------------- | :------------------------------------------------------------------ |
| 目標選択           | 任意（必須ではない）                                                |
| 複数選択           | 可能（1つの日報を複数の目標に関連付けられる）                       |
| 目標の表示形式     | 目標名 + 階層レベル表示（例: 「長期」「中期」「短期」のラベル表示） |
| 選択インタフェース | セレクトフィールド（検索可能）                                      |
| 階層構造の表示     | 目標選択時に親子関係が視覚的に分かるように表示                      |

#### 3.1.2 日報編集時の目標変更

| 項目           | 仕様                                     |
| :------------- | :--------------------------------------- |
| 目標の追加     | 新しい目標を追加できる                   |
| 目標の削除     | 既存の関連付けを削除できる               |
| 目標の入れ替え | 関連付けられた目標を一括で入れ替えられる |

#### 3.1.3 目標選択の制約

- すでに削除された目標は選択できない
- 非アクティブな目標も選択可能（過去の日報で関連付けられていた目標を維持するため）

### 3.2 日報一覧での目標表示

| 項目             | 仕様                                                                      |
| :--------------- | :------------------------------------------------------------------------ |
| 表示形式         | 目標名をチップ形式で表示                                                  |
| 複数目標の表示   | すべての関連目標をチップで表示（最大3つまで表示、それ以上は「+N」と表示） |
| 目標クリック動作 | 目標チップをクリックすると、目標詳細画面に遷移                            |
| 空状態           | 目標が関連付けられていない場合は、チップを表示しない                      |

### 3.3 目標詳細画面での関連日報表示

| 項目             | 仕様                                                       |
| :--------------- | :--------------------------------------------------------- |
| 表示位置         | 目標詳細画面の下部に「関連する日報」セクションを追加       |
| 表示形式         | 日報カード形式で一覧表示                                   |
| 並び替え         | 時系列（新しい順/古い順）で並び替え可能                    |
| 日報総数表示     | 関連日報の総数を表示（例: 「関連する日報（15件）」）       |
| ページネーション | 初期表示は最大10件、それ以上は「もっと見る」で追加読み込み |
| 空状態           | 関連日報がない場合は、空状態メッセージを表示               |

### 3.4 目標階層構造との整合性

| 項目               | 仕様                                                             |
| :----------------- | :--------------------------------------------------------------- |
| 階層レベルの表示   | 目標名の横に階層レベルを表示（「長期」「中期」「短期」のラベル） |
| 親子関係の表示     | 目標選択時に親子関係がツリー形式で表示される                     |
| 階層フィルタリング | 目標選択時に階層レベルでフィルタリングできる（任意）             |

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 日報作成画面の読み込み時間: 1秒以内
- 目標詳細画面での関連日報表示: 1秒以内
- 目標選択のサジェスト表示: 500ms以内

### 4.2 データ整合性

- 削除された目標への関連付けは保持されるが、選択肢には表示されない
- 目標の期間変更は、既存の関連付けに影響しない

### 4.3 アクセシビリティ

- 目標選択フィールドはキーボード操作に対応
- スクリーンリーダーに対応（目標名と階層レベルを読み上げ）

### 4.4 レスポンシブ対応

- デザインシステムに準拠したレスポンシブ対応

---

## 5. 画面遷移

### 5.1 日報作成フロー

```
日報作成画面
├─ 目標選択フィールド（任意）
│  ├─ 目標検索
│  ├─ 目標の階層構造表示
│  └─ 複数選択可能
├─ 他のフィールド（やったこと、よかったこと、改善点）
└─ 保存ボタン
   └─ 日報一覧画面へ遷移
```

### 5.2 日報編集フロー

```
日報詳細画面
├─ 編集ボタンをクリック
└─ 日報編集画面
   ├─ 関連付けられた目標を確認・編集
   └─ 保存ボタン
      └─ 日報詳細画面へ遷移
```

### 5.3 目標詳細画面での日報確認フロー

```
目標詳細画面
├─ 目標の基本情報
├─ 関連する週次フォーカス（既存機能）
└─ 関連する日報（新規）
   ├─ 日報一覧（最大10件）
   ├─ 並び替え（新しい順/古い順）
   └─ 日報カードをクリック
      └─ 日報詳細画面へ遷移
```

---

## 6. エッジケース

### 6.1 削除された目標への対応

- **問題**: 日報に関連付けられた目標が削除された場合、どう表示するか
- **対応**: 削除された目標は「（削除済み）目標名」として表示し、クリックできない

### 6.2 目標の期間外の日報

- **問題**: 目標の期間外に記録された日報を関連付けられるか
- **対応**: 期間外でも関連付け可能（警告表示なし）

### 6.3 大量の目標が関連付けられた場合

- **問題**: 1つの日報に多数の目標が関連付けられた場合、表示が煩雑になる
- **対応**: 日報一覧では最大3つまで表示し、それ以上は「+N」と表示

### 6.4 目標の名前変更

- **問題**: 目標の名前が変更された場合、関連付けられた日報の表示はどうなるか
- **対応**: 関連付けはIDで管理されるため、目標名が変更されても自動的に最新の名前が表示される

### 6.5 循環参照の防止

- **問題**: 目標階層構造で循環参照が発生した場合
- **対応**: 目標階層管理機能（BL-01）で循環参照を防止しているため、日報関連付けでは考慮不要

---

## 7. ビジネスルール

### 7.1 関連付けの任意性

- 日報と目標の関連付けは任意（必須ではない）
- 関連付けなしでも日報を作成・保存できる

### 7.2 複数目標への関連付け

- 1つの日報を複数の目標に関連付けられる
- 関連付ける目標の数に上限はない（実用上は10個程度を想定）

### 7.3 削除時の挙動

- 日報を削除した場合、目標との関連付けも削除される
- 目標を削除した場合、関連付けは保持されるが「削除済み」として表示される

---

## 8. メッセージ仕様

### 8.1 成功メッセージ

- 日報作成成功: 「日報を作成しました」
- 日報更新成功: 「日報を更新しました」

### 8.2 エラーメッセージ

- 目標取得失敗: 「目標の取得に失敗しました。もう一度お試しください。」
- 日報作成失敗: 「日報の作成に失敗しました。もう一度お試しください。」
- 日報更新失敗: 「日報の更新に失敗しました。もう一度お試しください。」

### 8.3 空状態メッセージ

- 目標が選択されていない場合: （メッセージなし、チップを表示しない）
- 関連日報がない場合: 「この目標に関連する日報はまだありません」

---

## 9. 制約事項

### 9.1 前提条件

- 目標階層管理機能（BL-01）が実装されていること
- ユーザーが少なくとも1つの目標を作成していること（目標がない場合は関連付け不可）

### 9.2 技術的制約

- 目標と日報の関連付けは多対多（Many-to-Many）の関係
- 関連付けデータは専用のテーブル（daily_report_goals）で管理

### 9.3 スコープ外

- 自動関連付けの提案機能（Phase 2で検討）
- 目標ごとの貢献度定量化（将来フェーズで検討）
- キーワードベースの自動関連付け（Phase 2で検討）

---

## 10. Phase 2以降の検討事項

### 10.1 自動関連付けの提案（Phase 2）

- 週次フォーカスに設定された目標を、その週の日報作成時に自動的に提案する
- キーワードベースの関連付け提案（日報の内容から目標を推薦）

### 10.2 目標ごとの貢献度定量化（将来）

- 複数の目標に関連付けられた日報について、各目標への貢献度を定量化する
- 目標達成率の計算に貢献度を活用する

---

## 11. 依存関係

### 11.1 前提となる機能

- **BL-01: 目標階層管理機能**（必須、実装済み）
  - 目標の作成・編集・削除
  - 目標の階層構造管理
  - 目標の詳細画面

### 11.2 関連する機能

- **週次フォーカス機能**（既存）
  - Phase 2で自動関連付け提案に活用予定
- **日報機能**（既存）
  - 日報作成・編集画面に目標選択機能を追加
  - 日報一覧画面に目標表示を追加

### 11.3 後続機能への影響

- **BL-04: フォローアップと目標の接続機能**
  - 本機能と同様の設計パターンを採用予定
- **BL-06: 目標別取り組み集約表示機能**
  - 本機能で実装される関連付けデータを活用
- **BL-07: アクティビティタイムライン機能**
  - 本機能で実装される関連付けデータを活用

---

## 12. セルフレビュー結果

### 12.1 要件の明確性

- [x] ユーザーストーリーが明確に定義されている
- [x] 受け入れ基準が具体的に記載されている
- [x] 機能要件が詳細に定義されている

### 12.2 エッジケースの洗い出し

- [x] 削除された目標への対応が定義されている
- [x] 目標の期間外の日報への対応が定義されている
- [x] 大量の目標が関連付けられた場合の対応が定義されている
- [x] 目標の名前変更時の対応が定義されている

### 12.3 ビジネスルールの明文化

- [x] 関連付けの任意性が明確に定義されている
- [x] 複数目標への関連付けが許可されている
- [x] 削除時の挙動が明確に定義されている

### 12.4 フィードバック反映

セルフレビューの結果、以下の点を追加・修正しました：

- 目標階層構造との整合性を機能要件に追加
- Phase 2以降の検討事項を明確化
- 依存関係と後続機能への影響を明記
- 関連付けの任意性を強調

**ステータス**: Approved（セルフレビュー完了）

---

_本PRDは、日報と目標の関連付け機能の要件を定義したものです。_
