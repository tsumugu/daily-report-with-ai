# Tech Spec Helperレビュー

**機能名**: 日報と目標の関連付け機能
**レビュー日**: 2025-12-16
**レビュアー**: Helper
**ステータス**: Approved（改善提案あり）

---

## 1. レビュー観点

### 1.1 エッジケース・境界値の検討

#### ✅ 良好な点

- 削除された目標への対応が明確に定義されている
- 無効な目標IDが指定された場合のエラーハンドリングが定義されている
- ユニーク制約（`dailyReportId` と `goalId` の組み合わせ）が考慮されている

#### ⚠️ 改善提案

**提案1: 目標の期間外の日報に対する関連付けの扱い**

PRDでは「期間外でも関連付け可能（警告表示なし）」とされているが、以下のケースを考慮すべき：

- **ケース**: 目標の期間が 2025-01-01 ~ 2025-06-30 だが、2025-12-16 の日報に関連付ける
- **問題**: ユーザーが誤って期間外の目標を選択する可能性がある
- **提案**: フロントエンドで視覚的なヒント（薄い表示、アイコン等）を提供し、ユーザーに期間外であることを通知する（任意）

**提案2: 大量の目標が関連付けられた場合のパフォーマンス**

PRDでは「日報一覧では最大3つまで表示」とされているが、以下を考慮すべき：

- **ケース**: 1つの日報に100個の目標が関連付けられた場合
- **問題**: データベース取得時のパフォーマンス低下、レスポンスサイズの増大
- **提案**:
  - 関連付け可能な目標数に上限を設ける（例: 最大10個）
  - または、フロントエンドで警告を表示し、ユーザーに意図を確認する

**提案3: 同時編集時の競合**

- **ケース**: ユーザーAが日報を編集中に、ユーザーBが同じ日報の目標を編集する
- **問題**: 同時編集による競合（ただし、日報は個人所有なので発生しにくい）
- **対応**: Phase 1ではスコープ外とし、楽観的ロック（`updatedAt` チェック）で対応する

### 1.2 パフォーマンス・最適化の方針

#### ✅ 良好な点

- 目標選択時のキャッシュが考慮されている
- 目標詳細画面での関連日報表示にページネーション対応
- 日報一覧での目標表示は必要最小限の情報のみ

#### ⚠️ 改善提案

**提案4: N+1問題の回避**

- **問題**: 日報一覧取得時に、各日報に対して個別に目標情報を取得すると N+1 問題が発生する
- **提案**:
  - 一括取得を実装する（`findByDailyReportIds()` メソッドを追加）
  - または、JOIN クエリで一度に取得する（将来的にRDBMS導入時）

```typescript
// 改善案: 一括取得
findByDailyReportIds(dailyReportIds: string[]): Map<string, DailyReportGoal[]> {
  const result = new Map<string, DailyReportGoal[]>();
  for (const drg of this.dailyReportGoals.values()) {
    if (dailyReportIds.includes(drg.dailyReportId)) {
      if (!result.has(drg.dailyReportId)) {
        result.set(drg.dailyReportId, []);
      }
      result.get(drg.dailyReportId)!.push(drg);
    }
  }
  return result;
}
```

**提案5: 目標選択時の検索パフォーマンス**

- **問題**: 目標数が増えると、検索が遅くなる可能性がある
- **提案**:
  - フロントエンドで debounce を実装し、検索APIの呼び出し回数を減らす
  - または、クライアント側でフィルタリングする（目標数が100件以下の場合）

### 1.3 セキュリティ・データ整合性の考慮

#### ✅ 良好な点

- アクセス制御が適切に定義されている（所有権チェック）
- バリデーションが明確に定義されている
- 外部キー制約が考慮されている

#### ⚠️ 改善提案

**提案6: 日報削除時の関連付けデータの扱い**

- **問題**: 日報削除時に、関連付けデータ（`DailyReportGoal`）を削除する必要がある
- **提案**:
  - `DailyReportsDatabase.delete()` メソッドで、関連付けデータも削除する
  - または、CASCADE DELETE を実装する（将来的にRDBMS導入時）

```typescript
// 改善案: 日報削除時の処理
delete(id: string): void {
  this.reports.delete(id);
  // 関連付けデータも削除
  dailyReportGoalsDb.deleteByDailyReportId(id);
}
```

**提案7: 目標削除時の関連付けデータの扱い**

Tech Specでは「目標削除時に、関連付けデータは削除しない」とされているが、以下を考慮すべき：

- **問題**: 削除された目標に関連付けられた日報が増えると、データベースに不要なレコードが蓄積される
- **提案**:
  - 削除された目標に関連付けられた日報を定期的にクリーンアップする（バッチ処理）
  - または、削除された目標の関連付けも削除する（ユーザーの意図によって判断）

### 1.4 過去の実績や失敗事例から学ぶべき点

#### ✅ 良好な点

- BL-01（目標階層管理機能）の実装パターンを参考にしている
- 既存の日報API・データモデルを適切に拡張している

#### ⚠️ 改善提案

**提案8: 週次フォーカスとの統一性**

- **背景**: 週次フォーカスも `goalId` フィールドで目標に関連付けられている
- **提案**:
  - 日報、フォローアップ、週次フォーカスの関連付け方法を統一する
  - 共通のインターフェースやユーティリティ関数を提供する（例: `linkToGoal()`, `unlinkFromGoal()`）

**提案9: 関連付けの履歴管理**

- **背景**: 将来的に、関連付けの履歴を追跡したい場合がある（例: いつ関連付けが追加/削除されたか）
- **提案**:
  - Phase 1ではスコープ外とし、`DailyReportGoal` の `createdAt` のみ記録
  - Phase 2以降で、削除時に論理削除（`deletedAt`）を検討

### 1.5 実装前に検討すべき事項

#### ⚠️ 検討事項

**検討1: 目標選択UIのユーザビリティ**

- **問題**: 目標数が多い場合、目標選択が煩雑になる
- **検討**:
  - 階層構造をツリー形式で表示するか、フラットリスト形式で表示するか
  - 最近使用した目標を優先的に表示するか
  - お気に入り目標機能を追加するか（Phase 2以降）

**検討2: 日報一覧での目標表示の優先順位**

- **問題**: 複数の目標が関連付けられた場合、どの目標を優先的に表示するか
- **検討**:
  - 目標の期間（短期目標を優先）
  - 目標の作成日（新しい目標を優先）
  - 階層レベル（下位目標を優先）
  - ユーザーが選択した順序（最初の3つ）

PRDでは言及されていないため、実装前に決定する必要がある。

**検討3: 自動関連付けのスコープ（Phase 2）**

- **背景**: Phase 2で自動関連付け機能を検討する予定
- **検討**:
  - 週次フォーカス連携のみか、キーワードベースも含むか
  - キーワードベースの場合、どのようなアルゴリズムを使用するか
  - ユーザーが自動関連付けをオフにできるようにするか

Phase 1では考慮不要だが、データモデル設計時に将来的な拡張を意識する。

---

## 2. 改善提案のまとめ

### 優先度: 高（Phase 1で対応推奨）

1. **N+1問題の回避**（提案4）
   - 日報一覧取得時の一括取得を実装
   - `findByDailyReportIds()` メソッドを追加

2. **日報削除時の関連付けデータの削除**（提案6）
   - `DailyReportsDatabase.delete()` で関連付けデータも削除

3. **日報一覧での目標表示の優先順位**（検討2）
   - 実装前に決定する必要がある

### 優先度: 中（Phase 1で検討推奨）

4. **大量の目標が関連付けられた場合の上限**（提案2）
   - 関連付け可能な目標数に上限を設ける（例: 最大10個）

5. **目標選択時の検索パフォーマンス**（提案5）
   - フロントエンドで debounce を実装

6. **目標選択UIのユーザビリティ**（検討1）
   - 階層構造の表示方法を決定

### 優先度: 低（Phase 2以降で検討）

7. **目標の期間外の日報に対する警告表示**（提案1）
   - フロントエンドで視覚的なヒントを提供

8. **週次フォーカスとの統一性**（提案8）
   - 共通のインターフェースやユーティリティ関数を提供

9. **目標削除時の関連付けデータのクリーンアップ**（提案7）
   - バッチ処理でクリーンアップ

10. **関連付けの履歴管理**（提案9）
    - 論理削除（`deletedAt`）を検討

---

## 3. 承認

上記の改善提案を Tech Spec に反映することを推奨します。特に優先度「高」の項目（提案4、提案6、検討2）は Phase 1 で対応すべきです。

その他の提案は Phase 2以降で検討可能ですが、データモデル設計時に将来的な拡張を意識することを推奨します。

**ステータス**: Approved（改善提案を反映後、実装可能）

---

_本レビューは、Tech Spec の横断的なレビューを実施したものです。_
