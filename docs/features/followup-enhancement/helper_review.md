# フォローアップ動作改善 Helperレビュー

**バージョン**: Phase 2 v2  
**作成日**: 2025-12-10  
**作成者**: Helper  
**ステータス**: Approved  
**レビュー対象**: `tech_spec.md`

---

## 1. レビュー概要

`tech_spec.md` を横断的にレビューし、エッジケース・パフォーマンス・セキュリティ・データ整合性等の観点からフィードバックを提供する。

---

## 2. レビュー観点

### ✅ エッジケース・境界値の検討

#### 2.1 既存データとの互換性

**確認事項**: 既存のフォローアップデータとの互換性が適切に考慮されているか

**レビュー結果**: ✅ 適切

- 既存の `Followup` モデルを活用する方針で、既存データとの互換性が保たれる
- 既存データと新方式のデータが混在しても問題なく動作する設計

**改善提案**:

- 既存のフォローアップデータで `status` が「再現成功」または「完了」以外の場合の扱いを明確化する
  - 例: `status` が「進行中」の既存フォローアップは、エピソード/アクション数にカウントされない（既存の手動ステータス管理として扱う）

#### 2.2 エピソード/アクション削除時のエッジケース

**確認事項**: 削除時のエッジケースが適切に考慮されているか

**レビュー結果**: ✅ 適切

- 削除後のステータス再計算ロジックが明確に定義されている
- 閾値を下回った場合のステータス変更（「再現成功」→「進行中」）が考慮されている

**改善提案**:

- 削除対象のエピソード/アクションが存在しない場合のエラーハンドリングを明確化する
  - 例: 既に削除済みのエピソード/アクションを削除しようとした場合のエラーレスポンス

#### 2.3 日付の境界値

**確認事項**: 日付の境界値（未来日付、過去日付等）が適切に考慮されているか

**レビュー結果**: ⚠️ 要検討

- 現在の設計では、日付の形式（YYYY-MM-DD）のみ検証している
- 未来日付や過去日付の制限が明記されていない

**改善提案**:

- 日付の妥当性チェックを追加する
  - 例: 未来日付は許可しない、または許可する場合は明記する
  - 例: 過去日付の制限（例: 1年以上前の日付は許可しない）を検討する

---

### ✅ パフォーマンス・最適化の方針

#### 3.1 エピソード/アクション数の増加

**確認事項**: エピソード/アクション数が増加した場合のパフォーマンス影響が考慮されているか

**レビュー結果**: ✅ 適切

- 現時点ではインメモリDBを使用しているため、パフォーマンス問題は発生しにくい
- エピソード/アクション数が増えても、カウント処理は高速

**改善提案**:

- 将来的にDBに移行する場合のインデックス設計を検討する
  - 例: `itemType` と `itemId` の複合インデックスを設定
  - 例: `status` フィールドにもインデックスを設定（カウント処理の高速化）

#### 3.2 ステータス再計算の最適化

**確認事項**: ステータス再計算のタイミングと最適化が適切か

**レビュー結果**: ✅ 適切

- エピソード/アクション追加/削除時のみステータスを再計算する方針で、効率的
- バッチ処理での再計算は不要（リアルタイムで更新）

**改善提案**:

- 既存データの読み込み時にステータスを再計算する必要がある場合の実装方針を明確化する
  - 例: 初回読み込み時に全データのステータスを再計算するか、必要に応じて再計算するか

---

### ✅ セキュリティ・データ整合性の考慮

#### 4.1 認証・認可

**確認事項**: 認証・認可が適切に考慮されているか

**レビュー結果**: ✅ 適切

- 既存の `authMiddleware` を活用する方針で、一貫性が保たれる
- エピソード/アクション追加/削除時は、ユーザーIDを確認する設計

**改善提案**:

- エピソード/アクション削除時の権限チェックを明確化する
  - 例: 削除対象のエピソード/アクションが自分のものであることを確認する

#### 4.2 データ整合性

**確認事項**: データ整合性が適切に考慮されているか

**レビュー結果**: ✅ 適切

- エピソード/アクション削除時、ステータスが自動的に再計算される設計
- `success_count` がエピソード/アクション数と連動する設計

**改善提案**:

- トランザクション処理の必要性を検討する
  - 例: エピソード/アクション追加時、`Followup` の保存と `GoodPoint` の更新を原子性のある操作として扱う
  - 現時点ではインメモリDBのため問題ないが、将来的にDBに移行する場合を考慮

---

### ✅ 過去の実績や失敗事例から学ぶべき点

#### 5.1 既存実装の参考

**確認事項**: 既存のフォローアップ管理機能の実装から学ぶべき点があるか

**レビュー結果**: ✅ 適切

- 既存の `Followup` モデルを活用する方針で、既存実装との一貫性が保たれる
- 既存のAPIパターンを踏襲している

**改善提案**:

- 既存のフォローアップ管理機能で発生した問題を参考にする
  - 例: ステータス更新のタイミングに関する問題（既存実装では `success_count` の更新タイミングが明確）

#### 5.2 UI設計との整合性

**確認事項**: UI設計との整合性が保たれているか

**レビュー結果**: ⚠️ 要確認

- UI設計では「フォローアップ入力モーダル」と記載されているが、tech_specでは「フォローアップ入力画面（ページ遷移）」と記載されている
- 週次フォーカスカードからの遷移について、UI設計とtech_specで不一致がある可能性

**改善提案**:

- UI設計とtech_specの整合性を確認する
  - UI設計: 「フォローアップ入力モーダル」を開く
  - tech_spec: 「フォローアップ入力画面に遷移」
  - → どちらが正しいか確認が必要

---

### ✅ 実装前に検討すべき事項

#### 6.1 既存APIとの互換性

**確認事項**: 既存APIとの互換性が適切に考慮されているか

**レビュー結果**: ⚠️ 要検討

- 既存の `POST /api/good-points/:id/followups` は `status` フィールドを必須としている
- 新設計では `status` フィールドを不要にしているが、既存APIとの互換性について考慮が必要

**改善提案**:

- 既存APIとの互換性を保つため、以下のいずれかの方針を採用する:
  1. **後方互換性を保つ**: `status` フィールドを任意とし、指定されない場合は自動的に「再現成功」または「完了」を設定
  2. **新APIを追加**: エピソード/アクション専用のAPIを追加し、既存APIは維持
  3. **既存APIを拡張**: 既存APIを拡張し、`status` が指定されない場合は自動的に設定

**推奨**: 1の後方互換性を保つ方針を推奨（既存クライアントコードへの影響を最小限に抑える）

#### 6.2 エピソード/アクション数のカウント方法

**確認事項**: エピソード/アクション数のカウント方法が明確か

**レビュー結果**: ✅ 適切

- カウント方法が明確に定義されている（`itemType === 'goodPoint'` かつ `status === '再現成功'` の件数）

**改善提案**:

- 既存のフォローアップデータで `status` が「再現成功」または「完了」以外の場合の扱いを明確化する
  - 例: 既存データで `status` が「進行中」の場合は、エピソード/アクション数にカウントされない

#### 6.3 ステータス自動判定の閾値

**確認事項**: ステータス自動判定の閾値が適切に定義されているか

**レビュー結果**: ✅ 適切

- 閾値が3回（固定）と明確に定義されている
- Phase 3以降で設定可能にする予定が明記されている

**改善提案**:

- 閾値の定数化を検討する
  - 例: `const EPISODE_THRESHOLD = 3;` として定数化し、将来的に設定可能にする際の変更を容易にする

---

## 3. 総合評価

### 3.1 強み

- ✅ 既存のデータモデルを活用する方針で、実装コストが低い
- ✅ ステータス自動判定ロジックが明確に定義されている
- ✅ 既存データとの互換性が考慮されている
- ✅ エラーハンドリングが適切に考慮されている

### 3.2 改善が必要な点

- ⚠️ 既存APIとの互換性について、具体的な実装方針を明確化する必要がある
- ⚠️ UI設計との整合性を確認する必要がある
- ⚠️ 日付の境界値（未来日付、過去日付等）の制限を明確化する必要がある

### 3.3 推奨事項

1. **既存APIとの互換性**: 後方互換性を保つ方針を採用し、`status` フィールドを任意とする
2. **UI設計との整合性**: UI設計とtech_specの整合性を確認し、必要に応じて修正する
3. **日付の境界値**: 日付の妥当性チェックを追加し、未来日付や過去日付の制限を明確化する
4. **エラーハンドリング**: 削除対象が存在しない場合のエラーハンドリングを明確化する

---

## 4. 承認

**レビュー結果**: ✅ **承認（条件付き）**

**条件**:

- 既存APIとの互換性について、具体的な実装方針を明確化すること
- UI設計との整合性を確認し、必要に応じて修正すること
- 日付の境界値の制限を明確化すること

**承認日**: 2025-12-10  
**承認者**: Helper

---

_本レビューは Helper ロールによる横断的レビューです。フィードバックを `tech_spec.md` に反映してください。_
