# フォローアップ動作改善 技術リサーチ

**バージョン**: Phase 2 v2  
**作成日**: 2025-12-10  
**作成者**: Eng  
**ステータス**: Approved

---

## 1. 概要

フォローアップ動作改善機能の実現方法について、一般的な手法・類似事例・ベストプラクティスを調査し、技術的な実装方針を検討する。

---

## 2. 要件の整理

### 2.1 主要要件

1. **エピソード/アクションの複数登録機能**
   - よかったこと: 再現エピソードを複数登録
   - 改善点: アクションを複数登録
   - エピソード/アクション情報: 再現日/完了日、メモ（500文字以内）

2. **ステータス自動判定**
   - エピソード/アクション数に基づいて自動判定
   - 閾値: 3回（固定）
   - 0件 → 未着手、1件以上 → 進行中、閾値以上 → 再現成功/完了

3. **週次フォーカスカードへのフォローアップボタン追加**
   - ホーム画面の週次フォーカスカードから直接フォローアップを入力できるようにする

---

## 3. 技術的検討事項

### 3.1 データモデル設計

#### 既存実装の確認

既存のフォローアップ機能では、`Followup` モデルが以下の構造で実装されている：

```typescript
interface Followup {
  id: string;
  userId: string;
  itemType: "goodPoint" | "improvement";
  itemId: string;
  status: FollowupStatus;
  memo: string | null;
  date: string | null; // YYYY-MM-DD
  createdAt: string;
  updatedAt: string;
}
```

#### 設計方針

**既存の `Followup` モデルを活用する方針**

- エピソード/アクションは `Followup` として保存
- よかったことの場合:
  - `status`: 常に「再現成功」（エピソード登録時）
  - `date`: 再現日（必須）
  - `memo`: 再現メモ（任意、最大500文字）
- 改善点の場合:
  - `status`: 常に「完了」（アクション登録時）
  - `date`: 完了日（必須）
  - `memo`: 進捗メモ（任意、最大500文字）

**メリット**:

- 既存のデータモデルを活用でき、実装コストが低い
- 既存のフォローアップ履歴と互換性を保てる
- データベーススキーマの変更が不要

**デメリット**:

- `status` フィールドが常に同じ値になる（「再現成功」または「完了」）
- 将来的にステータス管理が複雑になる可能性がある

**結論**: 既存の `Followup` モデルを活用する方針で進める。将来的な拡張性を考慮し、エピソード/アクション専用のモデルを追加することも検討できるが、Phase 2 v2では既存モデルの活用を優先する。

### 3.2 ステータス自動判定ロジック

#### 実装方針

**エピソード/アクション数のカウント方法**

- エピソード数: `itemType === 'goodPoint'` かつ `status === '再現成功'` の `Followup` の件数
- アクション数: `itemType === 'improvement'` かつ `status === '完了'` の `Followup` の件数

**ステータス自動判定ロジック**

```typescript
// よかったことの場合
const episodeCount = followups.filter(
  (f) => f.itemType === "goodPoint" && f.status === "再現成功",
).length;

if (episodeCount === 0) {
  status = "未着手";
} else if (episodeCount >= THRESHOLD) {
  // THRESHOLD = 3
  status = "再現成功";
} else {
  status = "進行中";
}

// 改善点の場合
const actionCount = followups.filter(
  (f) => f.itemType === "improvement" && f.status === "完了",
).length;

if (actionCount === 0) {
  status = "未着手";
} else if (actionCount >= THRESHOLD) {
  // THRESHOLD = 3
  status = "完了";
} else {
  status = "進行中";
}
```

**実装タイミング**

- エピソード/アクション追加時: 追加後にステータスを再計算
- エピソード/アクション削除時: 削除後にステータスを再計算
- 既存データのマイグレーション時: 初回読み込み時にステータスを再計算

**パフォーマンス考慮**

- エピソード/アクション数が増えた場合のパフォーマンス影響を考慮
- インメモリDBを使用しているため、現時点ではパフォーマンス問題は発生しにくい
- 将来的にDBに移行する場合は、インデックスを適切に設定する必要がある

### 3.3 API設計

#### エピソード/アクション追加API

**既存APIとの関係**

既存の `POST /api/good-points/:id/followups` と `POST /api/improvements/:id/followups` を活用する。

**変更点**

- リクエストボディの `status` フィールドは固定値（「再現成功」または「完了」）
- エピソード/アクション追加後、自動的にステータスを再計算
- ステータス変更時はトースト通知を表示（フロントエンド側で実装）

#### エピソード/アクション削除API

**新規API追加**

- `DELETE /api/good-points/:id/followups/:followupId`
- `DELETE /api/improvements/:id/followups/:followupId`

**実装内容**

- エピソード/アクション削除
- 削除後、ステータスを再計算
- ステータス変更時はトースト通知を表示

#### エピソード/アクション一覧取得API

**既存APIの活用**

既存の `GET /api/good-points/:id/followups` と `GET /api/improvements/:id/followups` を活用する。

**レスポンス形式**

```json
{
  "data": [
    {
      "id": "uuid",
      "date": "2025-12-10",
      "memo": "再現メモ...",
      "createdAt": "2025-12-10T12:00:00Z"
    }
  ]
}
```

### 3.4 週次フォーカスカードへのフォローアップボタン追加

#### 実装方針

**既存コンポーネントの拡張**

- `WeeklyFocusCardComponent` にフォローアップボタンを追加
- フォロー項目カードと同じスタイル（`variant="outline"`, `size="sm"`）
- クリック時はフォローアップ入力画面に遷移

**ルーティング**

- フォローアップ入力画面へのルートを追加
- パラメータとして `itemType` と `itemId` を渡す

**データ更新**

- フォローアップ入力後、週次フォーカスカードのステータス表示を自動更新
- `WeeklyFocusService` でフォーカス情報を再取得

---

## 4. 既存実装との互換性

### 4.1 データ互換性

**既存のフォローアップデータ**

- 既存のフォローアップデータはそのまま維持
- 新規登録から新方式（エピソード/アクション複数登録）を適用
- 既存データと新方式のデータが混在しても問題なく動作する

**ステータス管理**

- 既存の `GoodPoint` と `Improvement` の `status` フィールドは維持
- エピソード/アクション数に基づいて自動更新される
- 既存の手動ステータス更新機能は残す（後方互換性のため）

### 4.2 API互換性

**既存APIの維持**

- 既存のフォローアップ追加APIは維持
- 新規API（エピソード/アクション削除）を追加
- 既存のクライアントコードへの影響を最小限に抑える

---

## 5. パフォーマンス考慮事項

### 5.1 エピソード/アクション数の増加

**現状**

- インメモリDBを使用しているため、現時点ではパフォーマンス問題は発生しにくい
- エピソード/アクション数が増えても、カウント処理は高速

**将来の考慮事項**

- DBに移行する場合は、インデックスを適切に設定する必要がある
- `itemType` と `itemId` の複合インデックスを設定
- エピソード/アクション数が多い場合のページング対応を検討

### 5.2 ステータス再計算の最適化

**実装方針**

- エピソード/アクション追加/削除時のみステータスを再計算
- バッチ処理での再計算は不要（リアルタイムで更新）

---

## 6. セキュリティ考慮事項

### 6.1 認証・認可

**既存の認証ミドルウェアを活用**

- 既存の `authMiddleware` を活用
- エピソード/アクション追加/削除時は、ユーザーIDを確認
- 他のユーザーのエピソード/アクションにアクセスできないようにする

### 6.2 バリデーション

**入力値の検証**

- 日付形式の検証（YYYY-MM-DD）
- メモの文字数制限（最大500文字）
- 必須フィールドの検証

---

## 7. エラーハンドリング

### 7.1 エラーケース

**想定されるエラーケース**

- エピソード/アクション追加失敗（ネットワークエラー等）
- エピソード/アクション削除失敗（存在しないID等）
- バリデーションエラー（日付未入力、メモ文字数超過等）

**エラーハンドリング方針**

- 適切なHTTPステータスコードを返却
- エラーメッセージを明確に表示
- フロントエンド側でトースト通知を表示

---

## 8. テスト戦略

### 8.1 ユニットテスト

**テスト対象**

- ステータス自動判定ロジック
- エピソード/アクション数のカウント処理
- バリデーション処理

### 8.2 統合テスト

**テスト対象**

- エピソード/アクション追加API
- エピソード/アクション削除API
- ステータス自動更新の動作確認

### 8.3 E2Eテスト

**テスト対象**

- エピソード/アクションの追加フロー
- エピソード/アクションの削除フロー
- ステータス自動更新の動作確認
- 週次フォーカスカードからのフォローアップ入力フロー

---

## 9. 実装優先順位

### Phase 2 v2（MVP）

1. ✅ エピソード/アクションの複数登録機能
2. ✅ ステータス自動判定機能（閾値: 3回固定）
3. ✅ エピソード/アクション削除機能
4. ✅ 週次フォーカスカードへのフォローアップボタン追加

### 将来実装（Phase 3以降）

- 閾値のユーザー設定機能
- エピソード/アクションの編集機能
- エピソード/アクションの並び替え機能
- エピソード/アクションの検索・フィルタリング機能

---

## 10. 参考資料

- 既存実装: `docs/features/followup-management/tech_spec.md`
- PRD: `docs/features/followup-enhancement/prd.md`
- UI設計: `docs/features/followup-enhancement/ui_design.md`

---

_本技術リサーチは Approved ステータスです。tech_spec.md 作成の参考として使用します。_
