# 目標階層管理機能 振り返り（Retrospective）

**実施日**: 2025-12-14  
**参加ロール**: PdM, Eng, Des  
**対象機能**: 目標階層管理（目標の作成・編集・削除、階層構造の可視化、週次フォーカスとの接続）

---

## 1. Keep（良かった点・継続すべきこと）

### プロセス面

- **設計ドキュメントの徹底**: PRD → Tech Spec → UI Design の順で設計し、すべてのドキュメントがApprovedステータスになってから実装を開始できた
- **人間（human）レビューの導入**: 実装開始前の最終確認と実装完了後の成果物レビューを導入し、品質を担保できた
- **E2Eテストの早期作成**: ユーザーストーリーに基づいてE2Eテストを作成し、要件充足度を確認できた
- **テストカバレッジ99.92%の達成**: ResizeObserverのモックなど、複雑なDOM操作のテストを実装し、高いカバレッジを達成できた
- **段階的な実装**: Phase 1（設計）→ Phase 2（実装）→ Phase 3（検証）→ Phase 4（完了）の流れを守り、品質を担保できた

### 技術面

- **階層構造の可視化**: HierarchyTreeViewコンポーネントを実装し、階層構造を視覚的に表現できた
- **バリデーションロジックの実装**: 循環参照の防止、期間の整合性チェック、階層の深さチェックなど、堅牢なバリデーションを実装
- **ResizeObserverの活用**: カード要素のサイズ変更を監視し、コネクタラインを自動更新する仕組みを実装
- **既存コンポーネントの活用**: HierarchyCard、Button、InputFieldなど、既存のコンポーネントを活用し、開発効率を向上
- **テストの網羅性**: DOM操作を含む複雑なロジックも、モックを活用してテストカバーできた

### UI/UX面

- **ツリービューとカードビューの切り替え**: ViewToggleコンポーネントを実装し、ユーザーの好みに応じて表示形式を選択できるようにした
- **階層構造の視覚化**: L字のコネクタラインとプラスボタン同士を繋ぐ縦線を実装し、階層関係を明確に表現
- **空状態の適切な表示**: 目標が存在しない場合の空状態を実装し、ユーザーに次のアクションを促すUIを提供
- **レスポンシブ対応**: モバイル/PC両対応を継続し、様々なデバイスで利用可能

---

## 2. Problem（改善点・課題）

### プロセス面

- **テストカバレッジ100%の達成困難**: DOM操作に依存するコード（ResizeObserverのコールバック、getBoundingClientRectの計算）のテストが困難で、99.92%で止まった
- **E2Eテストの実装タイミング**: 機能実装完了後にE2Eテストを実装したが、実装と同時に進めるべきだった
- **Storybook更新の遅れ**: 実装完了後にStorybookの確認・更新を行ったが、実装と同時に更新すべきだった

### 技術面

- **ResizeObserverのテストの複雑さ**: ResizeObserverのコールバックをテストするために、複雑なモック設定が必要だった
- **DOM操作のテストの困難さ**: getBoundingClientRectの値をモックする際に、Object.definePropertyを使用する必要があり、テストコードが複雑になった
- **階層構造の計算ロジック**: 階層の深さを計算するロジックが複雑で、テストが困難だった

### UI/UX面

- **コネクタラインの描画**: プラスボタン同士を繋ぐ縦線の描画ロジックが複雑で、テストが困難だった
- **階層構造の表示**: 階層が深くなった場合の表示が複雑になる可能性がある

---

## 3. Try（次に試すアクション）

### プロセス面

1. **テストカバレッジの閾値設定**: DOM操作に依存するコードについては、100%を目指すのではなく、99%以上の閾値を設定する
2. **E2Eテストの早期実装**: 機能実装と同時にE2Eテストを実装し、要件充足度を早期に確認する
3. **Storybookの同時更新**: 実装と同時にStorybookを更新し、コンポーネントの動作を確認する

### 技術面

1. **テストヘルパーの作成**: ResizeObserverやgetBoundingClientRectのモックを簡単に行えるテストヘルパーを作成する
2. **DOM操作の抽象化**: DOM操作を抽象化し、テストしやすくする
3. **階層構造の計算ロジックの簡素化**: 階層の深さを計算するロジックを簡素化し、テストしやすくする

### UI/UX面

1. **コネクタラインの描画ロジックの改善**: プラスボタン同士を繋ぐ縦線の描画ロジックを改善し、よりシンプルにする
2. **階層構造の表示の最適化**: 階層が深くなった場合の表示を最適化する

---

_本振り返りは、目標階層管理機能の開発プロセスを振り返り、次回の開発に活かすためのものです。_
